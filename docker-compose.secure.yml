version: '3.9'

# ============================================
# DOCKER COMPOSE - SECURE PRODUCTION SETUP
# ============================================
# Con PostgreSQL, secrets, networking, monitoring
#
# Usage:
#   docker-compose -f docker-compose.secure.yml up -d
#
# Pre-requisites:
#   - .env.production file con secretos
#   - docker-compose v1.29+ (supports secrets)

services:
  # ============================================
  # REVERSE PROXY + TLS TERMINATION
  # ============================================
  nginx:
    image: nginx:1.25-alpine
    container_name: yukyu-nginx
    restart: always
    ports:
      - "443:443"  # HTTPS
      - "80:80"    # HTTP (redirect to HTTPS)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl/cert.pem:/etc/nginx/ssl/cert.pem:ro
      - ./nginx/ssl/key.pem:/etc/nginx/ssl/key.pem:ro
      - ./nginx/ssl/dhparam.pem:/etc/nginx/ssl/dhparam.pem:ro
    networks:
      - yukyu-network
    depends_on:
      - app
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /var/run
      - /var/cache
      - /var/log
    environment:
      - TZ=Asia/Tokyo
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - "com.yukyu.component=reverse-proxy"

  # ============================================
  # APPLICATION
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile.secure
    container_name: yukyu-app
    restart: always
    networks:
      - yukyu-network
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - APP_ENV=production
      - DEBUG=false
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

      # Database
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}

      # Security - REQUIRED: JWT_SECRET_KEY and CSRF_SECRET must be set
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CSRF_SECRET=${CSRF_SECRET}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      - API_KEY=${API_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - ENVIRONMENT=production

      # CORS
      - CORS_ORIGINS=${CORS_ORIGINS}

      # Redis (para rate limiting)
      - REDIS_URL=redis://redis:6379/0

      # Logging
      - LOG_LEVEL=info
      - SENTRY_DSN=${SENTRY_DSN}

    ports:
      # Solo localhost - nginx hace proxy
      - "127.0.0.1:8000:8000"

    volumes:
      # Data volume (para SQLite si fallback)
      - yukyu-data:/app/data:rw

      # Logs volume
      - yukyu-logs:/app/logs:rw

      # Read-only config
      - ./config.production.yaml:/app/config.yaml:ro

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cap_add:
      - SETUID
      - SETGID

    # Limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '1'
          memory: 256M

    # Validates both application health AND secrets configuration
    healthcheck:
      test: >
        sh -c '
        curl -f -s http://localhost:8000/health > /dev/null &&
        python -c "from config.secrets_validation import validate_secrets_healthcheck; exit(0 if validate_secrets_healthcheck() else 1)"
        '
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    labels:
      - "com.yukyu.component=app"
      - "com.yukyu.version=1.0"

  # ============================================
  # DATABASE - PostgreSQL
  # ============================================
  db:
    image: postgres:15-alpine
    container_name: yukyu-db
    restart: always
    networks:
      - yukyu-network
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
      - TZ=Asia/Tokyo

    volumes:
      # Data persistence
      - yukyu-db:/var/lib/postgresql/data

      # Initialization scripts
      - ./scripts/db-init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./scripts/db-security.sql:/docker-entrypoint-initdb.d/02-security.sql:ro

      # Backups
      - yukyu-backups:/backups

    ports:
      # Solo localhost - no acceso remoto
      - "127.0.0.1:5432:5432"

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    labels:
      - "com.yukyu.component=database"
      - "com.yukyu.critical=true"

  # ============================================
  # REDIS - Rate limiting & Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: yukyu-redis
    restart: always
    networks:
      - yukyu-network
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec

    volumes:
      - yukyu-redis:/data

    ports:
      - "127.0.0.1:6379:6379"

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.5'
          memory: 128M

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

    labels:
      - "com.yukyu.component=cache"

  # ============================================
  # LOGGING - Filebeat para ELK
  # ============================================
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.10.0
    container_name: yukyu-filebeat
    restart: always
    networks:
      - yukyu-network
    user: root
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - yukyu-logs:/var/log/yukyu:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=${ELASTICSEARCH_USER}
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}

    depends_on:
      - elasticsearch
      - app

    cap_drop:
      - ALL
    cap_add:
      - DAC_READ_SEARCH
      - SETGID

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

    labels:
      - "com.yukyu.component=logging"

  # ============================================
  # ELASTICSEARCH - Log aggregation
  # ============================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.0
    container_name: yukyu-elasticsearch
    restart: always
    networks:
      - yukyu-network
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - ELASTIC_USERNAME=${ELASTICSEARCH_USER}
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - TZ=Asia/Tokyo

    volumes:
      - yukyu-elasticsearch:/usr/share/elasticsearch/data

    ports:
      - "127.0.0.1:9200:9200"

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
      - SYS_CHROOT

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 | grep -q cluster_name || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

    labels:
      - "com.yukyu.component=logging"
      - "com.yukyu.critical=true"

  # ============================================
  # PROMETHEUS - Metrics
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: yukyu-prometheus
    restart: always
    networks:
      - yukyu-network
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - yukyu-prometheus:/prometheus

    ports:
      - "127.0.0.1:9090:9090"

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

    labels:
      - "com.yukyu.component=monitoring"

  # ============================================
  # GRAFANA - Visualization
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: yukyu-grafana
    restart: always
    networks:
      - yukyu-network
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      - GF_LOG_MODE=console
      - TZ=Asia/Tokyo

    volumes:
      - yukyu-grafana:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro

    ports:
      - "127.0.0.1:3000:3000"

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    labels:
      - "com.yukyu.component=monitoring"

  # ============================================
  # BACKUP SERVICE
  # ============================================
  backup:
    image: yukyu-backup:latest  # Custom image
    container_name: yukyu-backup
    restart: always
    networks:
      - yukyu-network
    environment:
      - DB_HOST=db
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_BUCKET=${S3_BACKUP_BUCKET}
      - BACKUP_SCHEDULE=0 2 * * *  # Daily at 2 AM

    volumes:
      - yukyu-backups:/backups
      - ./scripts/backup.sh:/app/backup.sh:ro

    depends_on:
      - db

    cap_drop:
      - ALL

    labels:
      - "com.yukyu.component=backup"

# ============================================
# NETWORKS
# ============================================
networks:
  yukyu-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ============================================
# VOLUMES
# ============================================
volumes:
  # Database
  yukyu-db:
    driver: local

  # Application
  yukyu-data:
    driver: local

  # Logs
  yukyu-logs:
    driver: local

  # Cache
  yukyu-redis:
    driver: local

  # Backups
  yukyu-backups:
    driver: local

  # Monitoring
  yukyu-prometheus:
    driver: local

  yukyu-elasticsearch:
    driver: local

  yukyu-grafana:
    driver: local

# ============================================
# SECURITY NOTES
# ============================================
# 1. Todos los servicios en red privada (172.25.0.0/16)
# 2. Solo nginx expone puertos p√∫blicos (80, 443)
# 3. Database solo accesible desde app
# 4. TLS termination en nginx
# 5. Secrets desde .env.production (no commiteado)
# 6. Health checks para orchestration
# 7. Resource limits para prevenir DoS
# 8. Read-only volumes donde es posible
# 9. Security options: no-new-privileges, cap_drop
# 10. Logging centralizado en Elasticsearch

# ============================================
# ENVIRONMENT VARIABLES REQUERIDAS
# ============================================
# Crear .env.production con:
#
# CRITICAL SECRETS (app will NOT start without these properly configured):
# JWT_SECRET_KEY=<min-32-chars-mixed-case-special>
# CSRF_SECRET=<min-16-chars>
#
# DATABASE:
# DB_USER=yukyu_app
# DB_PASSWORD=<strong-password>
# DB_NAME=yukyu_production
#
# RECOMMENDED SECRETS:
# API_KEY=<strong-api-key>
# ENCRYPTION_KEY=<64-hex-chars>
# CORS_ORIGINS=https://yukyu-data.example.com
# REDIS_PASSWORD=<redis-password>
#
# MONITORING:
# ELASTICSEARCH_USER=elastic
# ELASTICSEARCH_PASSWORD=<elastic-password>
# GRAFANA_USER=admin
# GRAFANA_PASSWORD=<grafana-password>
# SENTRY_DSN=https://...@sentry.io/...
#
# BACKUP:
# AWS_ACCESS_KEY_ID=<aws-key>
# AWS_SECRET_ACCESS_KEY=<aws-secret>
# S3_BACKUP_BUCKET=yukyu-backups-prod
#
# Generate secure secrets:
#   python -c "import secrets; print(secrets.token_urlsafe(32))"
#
# Verify secrets configuration:
#   docker exec yukyu-app python -c "from config.secrets_validation import print_secrets_status; print_secrets_status()"

# ============================================
# SECRETS VALIDATION
# ============================================
# The app healthcheck validates:
#   1. Application is responding to health endpoint
#   2. JWT_SECRET_KEY and CSRF_SECRET are properly configured
#   3. Secrets are not using insecure default values
#
# If validation fails in production:
#   - Container will be marked as unhealthy
#   - Application will exit with code 1 on startup
#   - Orchestrators (k8s, swarm) will restart/replace the container

<!DOCTYPE html>
<html lang="ja" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <!-- WCAG 1.4.4: Allow user zoom for accessibility -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>YuKyu Premium Dashboard</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="有給休暇管理システム - Premium Dashboard for managing paid leave">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YuKyu">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="YuKyu Premium">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="format-detection" content="telephone=no">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/static/icons/icon.svg">
    <link rel="apple-touch-icon" href="/static/icons/icon.svg">

    <!-- Fonts: Inter (UI) + JetBrains Mono (data) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- CDN preconnect for lazy-loaded libraries -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- === CSS LOADING ORDER === -->
    <!-- 1. v4: Layout, components, sidebar, grid (base styles) -->
    <link rel="stylesheet" href="/static/css/yukyu-design-v4.css">
    <!-- 2. v5: Design tokens override (colors, typography, shadows) -->
    <link rel="stylesheet" href="/static/css/yukyu-design-system-v5-professional.css">

    <!-- LEGACY CSS - DISABLED (Conflicting styles) -->
    <!-- <link rel="stylesheet" href="/static/css/unified-design-system.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/nexus-theme/main.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/ui-ux-fixes-2026.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/contrast-fix.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/sidebar-fix.css"> -->

    <!-- Libraries -->
    <!-- ApexCharts - Modern charting library -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>

    <!-- Chart.js - For pie and bar charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- GSAP and Animate.css: Loaded on-demand via animation-loader.js module -->
    <!-- This improves Time to Interactive by ~200ms on initial load -->
    <!-- See: static/js/modules/animation-loader.js -->

    <!-- Flatpickr - Modern Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/dark.css">

    <!-- Flatpickr styles now in yukyu-design-v4.css -->

    <!-- Modern UI Enhancements -->
    <script src="/static/js/modern-ui.js" defer></script>
    <script src="/static/js/modern-integration.js" defer></script>

    <!-- Authentication System -->
    <link rel="stylesheet" href="/static/css/login-modal.css">
    <script type="module" src="/static/js/utils/auth-manager.js"></script>
    <script type="module" src="/static/js/components/login-modal.js"></script>

    <!-- LEGACY FIX CSS - DISABLED (now handled by yukyu-design-v3.css) -->
    <!-- <link rel="stylesheet" href="/static/css/ui-ux-fixes-2026.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/contrast-fix.css"> -->
</head>

<body>
    <!-- Skip Navigation for Accessibility -->
    <a href="#main-content" class="skip-link">メインコンテンツへ移動</a>

    <div class="app-container">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle navigation menu"
            aria-expanded="false">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>

        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" aria-hidden="true"></div>

        <!-- Sidebar Navigation - Premium Design -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <img src="/static/icons/logo-premium.svg" alt="YuKyu - Employee Vacation Management System" width="48"
                    height="48">
                <div>
                    <div>YUKYU</div>
                    <div>DATA</div>
                </div>
            </div>

            <div class="nav-section">
                <!-- Main Navigation Group -->
                <div class="nav-group">
                    <div class="nav-group-label">Main</div>

                    <button class="nav-item active" data-view="dashboard" data-action="ui.switchView"
                        aria-label="Dashboard" aria-current="page" type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7" rx="1" />
                                <rect x="14" y="3" width="7" height="7" rx="1" />
                                <rect x="3" y="14" width="7" height="7" rx="1" />
                                <rect x="14" y="14" width="7" height="7" rx="1" />
                            </svg>
                        </span>
                        <span class="nav-text">Dashboard</span>
                    </button>

                    <button class="nav-item" data-view="employees" data-action="ui.switchView" aria-label="Employees"
                        type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="7" r="4" />
                                <path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" />
                                <circle cx="17" cy="7" r="3" />
                                <path d="M21 21v-2a3 3 0 0 0-2-2.83" />
                            </svg>
                        </span>
                        <span class="nav-text">Employees</span>
                        <span class="nav-badge" id="emp-count-badge-sidebar" aria-label="Total employees">0</span>
                    </button>

                    <button class="nav-item" data-view="factories" data-action="ui.switchView" aria-label="Factories"
                        type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 20V8l6-4v4l6-4v4l6-4v16H2z" />
                                <path d="M6 12v4" />
                                <path d="M10 12v4" />
                                <path d="M14 12v4" />
                                <path d="M18 12v4" />
                            </svg>
                        </span>
                        <span class="nav-text">Factories</span>
                    </button>
                </div>

                <!-- Requests Group -->
                <div class="nav-group">
                    <div class="nav-group-label">Requests</div>

                    <button class="nav-item" data-view="requests" data-action="ui.switchView" aria-label="Request Leave"
                        type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                                <line x1="10" y1="9" x2="8" y2="9" />
                            </svg>
                        </span>
                        <span class="nav-text">申請 Request</span>
                    </button>

                    <button class="nav-item" data-view="calendar" data-action="ui.switchView" aria-label="Calendar"
                        type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                <line x1="16" y1="2" x2="16" y2="6" />
                                <line x1="8" y1="2" x2="8" y2="6" />
                                <line x1="3" y1="10" x2="21" y2="10" />
                                <path d="M8 14h.01" />
                                <path d="M12 14h.01" />
                                <path d="M16 14h.01" />
                                <path d="M8 18h.01" />
                                <path d="M12 18h.01" />
                            </svg>
                        </span>
                        <span class="nav-text">カレンダー</span>
                    </button>
                </div>

                <!-- Analytics Group -->
                <div class="nav-group">
                    <div class="nav-group-label">Analytics</div>

                    <button class="nav-item" data-view="compliance" data-action="ui.switchView" aria-label="Compliance"
                        type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                                <polyline points="9 12 11 14 15 10" />
                            </svg>
                        </span>
                        <span class="nav-text">Compliance</span>
                    </button>

                    <button class="nav-item" data-view="analytics" data-action="ui.switchView" aria-label="Analytics"
                        type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="20" x2="18" y2="10" />
                                <line x1="12" y1="20" x2="12" y2="4" />
                                <line x1="6" y1="20" x2="6" y2="14" />
                            </svg>
                        </span>
                        <span class="nav-text">分析 Analytics</span>
                    </button>

                    <button class="nav-item" data-view="reports" data-action="ui.switchView"
                        aria-label="Monthly Reports" type="button">
                        <span class="nav-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="12" y1="18" x2="12" y2="12" />
                                <line x1="9" y1="15" x2="15" y2="15" />
                            </svg>
                        </span>
                        <span class="nav-text">月次レポート</span>
                    </button>
                </div>
            </div>

            <!-- Settings at bottom -->
            <div class="sidebar-footer">
                <button class="nav-item nav-item-settings" data-view="settings" data-action="ui.switchView"
                    aria-label="Settings" type="button">
                    <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3" />
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                        </svg>
                    </span>
                    <span class="nav-text">Settings</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="main-content">

            <!-- Header -->
            <header class="flex-between mb-lg page-header">
                <div class="page-title-block">
                    <h1 class="text-gradient title-2xl" id="page-title">Dashboard Overview</h1>
                    <p class="text-muted" id="page-subtitle">Real-time vacation data analytics</p>
                </div>

                <div class="header-actions">
                    <div class="header-actions__group header-actions__group--years">
                        <span class="header-label">Año</span>
                        <select id="year-selector" class="input-glass year-dropdown"></select>
                    </div>

                    <div class="header-actions__group" id="header-controls">
                        <!-- Language Selector -->
                        <!-- Language Selector (Removed: Japanese Only) -->
                        <div class="language-indicator"
                            style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 0.9rem;">
                            <span class="language-flag">JP</span>
                            <span class="language-text">日本語</span>
                        </div>

                        <!-- Theme Toggle -->
                        <button class="theme-toggle" data-action="theme.toggle" title="テーマ切替" aria-label="Toggle theme"
                            type="button">
                            <div class="theme-toggle-track">
                                <div class="theme-toggle-thumb">
                                    <svg id="theme-icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                                    </svg>
                                    <svg id="theme-icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" class="d-none">
                                        <circle cx="12" cy="12" r="5" />
                                        <line x1="12" y1="1" x2="12" y2="3" />
                                        <line x1="12" y1="21" x2="12" y2="23" />
                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                                        <line x1="1" y1="12" x2="3" y2="12" />
                                        <line x1="21" y1="12" x2="23" y2="12" />
                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                                    </svg>
                                </div>
                            </div>
                            <span class="theme-toggle-label" id="theme-label">Dark</span>
                        </button>

                        <!-- Auth Controls -->
                        <button class="btn btn-glass" id="btn-login" data-action="auth.showLogin" aria-label="Login">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                            </svg>
                            <span class="btn-text">Login</span>
                        </button>
                        <button class="btn btn-glass d-none" id="btn-logout" data-action="auth.logout"
                            aria-label="Logout">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                <path d="M7 11V7a5 5 0 0 1 9.9-1" />
                            </svg>
                            <span class="btn-text">Logout</span>
                        </button>

                        <button class="btn btn-primary" id="btn-sync-main" data-action="data.sync"
                            aria-label="Sync vacation data" type="button"
                            data-tooltip="有給データをExcelから同期 / Sincronizar datos de vacaciones" data-loading="同期中...">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                            </svg>
                            <span class="btn-text">Sync</span>
                            <span class="btn-spinner d-none"></span>
                        </button>
                        <button class="btn btn-glass" id="btn-sync-genzai" data-action="data.syncGenzai"
                            aria-label="Sync dispatch employees" type="button"
                            data-tooltip="派遣社員データを同期 / Sincronizar empleados dispatch" data-loading="同期中...">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                <polyline points="9 22 9 12 15 12 15 22" />
                            </svg>
                            <span class="btn-text d-md-inline d-none">Genzai</span>
                            <span class="btn-spinner d-none"></span>
                        </button>
                        <button class="btn btn-glass" id="btn-sync-ukeoi" data-action="data.syncUkeoi"
                            aria-label="Sync contract employees" type="button"
                            data-tooltip="請負社員データを同期 / Sincronizar empleados contrato" data-loading="同期中...">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path
                                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                            </svg>
                            <span class="btn-text d-md-inline d-none">Ukeoi</span>
                            <span class="btn-spinner d-none"></span>
                        </button>
                        <button class="btn btn-glass" id="btn-export-pdf" data-action="reports.showExportModal"
                            title="Export PDF Reports" aria-label="Export PDF reports" type="button">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                                <polyline points="10 9 9 9 8 9" />
                            </svg>
                            <span class="btn-text">PDF</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section active">

                <!-- Bento Grid Stats with Progress Rings -->
                <div class="bento-grid stagger-children" role="region" aria-label="Statistics Overview">
                    <!-- Usage Ring -->
                    <div class="glass-panel stat-card stat-card-ring col-span-1 glow-hover">
                        <div class="progress-ring-container">
                            <svg class="progress-ring" width="80" height="80">
                                <circle class="progress-ring__circle-bg" cx="40" cy="40" r="34"></circle>
                                <circle class="progress-ring__circle progress-ring__circle--success" id="ring-usage"
                                    role="img" aria-label="Usage progress" cx="40" cy="40" r="34"
                                    stroke-dasharray="213.6" stroke-dashoffset="213.6"></circle>
                            </svg>
                            <div class="progress-ring__value" id="ring-usage-value">0</div>
                        </div>
                        <div class="stat-label">Total Usage</div>
                        <div class="text-xs text-muted" id="kpi-used-detail">0 days
                        </div>
                    </div>

                    <!-- Balance Ring -->
                    <div class="glass-panel stat-card stat-card-ring col-span-1 glow-hover">
                        <div class="progress-ring-container">
                            <svg class="progress-ring" width="80" height="80">
                                <circle class="progress-ring__circle-bg" cx="40" cy="40" r="34"></circle>
                                <circle class="progress-ring__circle progress-ring__circle--warning" id="ring-balance"
                                    role="img" aria-label="Balance progress" cx="40" cy="40" r="34"
                                    stroke-dasharray="213.6" stroke-dashoffset="213.6"></circle>
                            </svg>
                            <div class="progress-ring__value" id="ring-balance-value">0</div>
                        </div>
                        <div class="stat-label">Remaining</div>
                        <div class="text-xs text-muted" id="kpi-balance-detail">0
                            days left</div>
                    </div>

                    <!-- Utilization Ring -->
                    <div class="glass-panel stat-card stat-card-ring col-span-1 glow-hover">
                        <div class="progress-ring-container">
                            <svg class="progress-ring" width="80" height="80">
                                <circle class="progress-ring__circle-bg" cx="40" cy="40" r="34"></circle>
                                <circle class="progress-ring__circle progress-ring__circle--primary" id="ring-rate"
                                    role="img" aria-label="Utilization rate" cx="40" cy="40" r="34"
                                    stroke-dasharray="213.6" stroke-dashoffset="213.6"></circle>
                            </svg>
                            <div class="progress-ring__value" id="ring-rate-value">0%</div>
                        </div>
                        <div class="stat-label">Utilization</div>
                        <div class="text-xs text-muted" id="kpi-rate-detail">avg rate
                        </div>
                    </div>

                    <!-- Employees Card -->
                    <div class="glass-panel stat-card col-span-1 kpi-card-highlight" data-action="ui.switchView"
                        data-view="employees">
                        <div class="stat-label">Employees</div>
                        <div class="stat-value count-up" id="kpi-total">-</div>
                        <div class="quick-stats">
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="qs-haken">0</div>
                                <div class="quick-stat-label">派遣</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="qs-ukeoi">0</div>
                                <div class="quick-stat-label">請負</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="qs-staff">0</div>
                                <div class="quick-stat-label">Staff</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Gauge Row -->
                <div class="bento-grid mb-lg">
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="stat-label mb-lg">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" class="inline-icon">
                                <line x1="12" y1="20" x2="12" y2="10" />
                                <line x1="18" y1="20" x2="18" y2="4" />
                                <line x1="6" y1="20" x2="6" y2="16" />
                            </svg>
                            Compliance Gauge (5日最低消化)
                        </h3>
                        <div class="gauge-container">
                            <svg class="gauge-svg" viewBox="0 0 200 120">
                                <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100" />
                                <path class="gauge-fill" id="gauge-compliance" d="M 20 100 A 80 80 0 0 1 180 100"
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke="var(--success)" />
                            </svg>
                            <div class="gauge-value" id="gauge-value">0%</div>
                            <div class="gauge-label">compliance rate</div>
                            <div class="gauge-markers">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                        <div class="text-center mt-lg text-sm text-muted">
                            <span id="compliance-count">0</span> of <span id="compliance-total">0</span>
                            employees have used ≥5 days
                        </div>
                    </div>

                    <!-- Expiring Days Alert -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="stat-label mb-lg">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" class="inline-icon text-warning">
                                <path
                                    d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                <line x1="12" y1="9" x2="12" y2="13" />
                                <line x1="12" y1="17" x2="12.01" y2="17" />
                            </svg>
                            Days Expiring Soon
                        </h3>
                        <div id="expiring-alert">
                            <div class="countdown-card d-none" id="countdown-container">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="countdown-icon text-warning">
                                    <circle cx="12" cy="12" r="10" />
                                    <polyline points="12 6 12 12 16 14" />
                                </svg>
                                <div class="countdown-info">
                                    <div class="countdown-title">有給休暇が失効予定</div>
                                    <div class="countdown-value" id="expiring-days">0 days</div>
                                    <div class="countdown-detail" id="expiring-detail">from 0 employees</div>
                                </div>
                            </div>
                            <div id="no-expiring" class="text-center p-xl text-success flex-center gap-sm">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                    <polyline points="22 4 12 14.01 9 11.01" />
                                </svg>
                                No days expiring soon!
                            </div>
                        </div>
                        <div class="quick-stats mt-lg">
                            <div class="quick-stat">
                                <div class="quick-stat-value text-danger" id="critical-count">
                                    0</div>
                                <div class="quick-stat-label">Critical (0日)</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value text-warning" id="warning-count">
                                    0</div>
                                <div class="quick-stat-label">Warning (&lt;3日)</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value text-success" id="healthy-count">
                                    0</div>
                                <div class="quick-stat-label">Healthy (≥5日)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="bento-grid">
                    <div class="glass-panel col-span-2 p-md h-400">
                        <h3 class="stat-label mb-lg">Usage Distribution</h3>
                        <div class="chart-container-sm">
                            <div id="chart-distribution"></div>
                        </div>
                    </div>
                    <div class="glass-panel col-span-2 p-md h-400">
                        <h3 class="stat-label mb-lg">Monthly Trends <span id="trends-year-label"></span></h3>
                        <div class="chart-container-sm">
                            <div id="chart-trends"></div>
                        </div>
                    </div>
                </div>

                <!-- Footer spacer -->
                <div class="mb-lg"></div>
            </div>

            <!-- VIEW: EMPLOYEES -->
            <div class="view-section d-none" id="view-employees">
                <div class="glass-panel p-lg">
                    <div class="flex-between mb-lg wrap-on-mobile">
                        <div class="flex-center gap-md mb-sm-mobile">
                            <h3 class="text-xl flex-center gap-sm">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="text-primary">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                従業員一覧
                            </h3>
                            <div class="badge badge-warning" id="emp-count-badge">0 Employees</div>
                        </div>
                        <div class="flex-center gap-md wrap-on-mobile w-full-mobile">
                            <label class="flex-center gap-sm cursor-pointer select-none" for="active-only-toggle">
                                <div class="relative">
                                    <input type="checkbox" id="active-only-toggle" checked
                                        onchange="App.employeeTypes.toggleActiveFilter()" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-surface-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-success-500 bg-gray-200 dark:bg-gray-700 checkbox-toggle-bg">
                                    </div>
                                </div>
                                <span class="text-sm font-medium">在職中のみ</span>
                            </label>

                            <div class="relative w-300 w-full-mobile">
                                <span
                                    class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-muted"
                                    style="top: 50%; transform: translateY(-50%); left: 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                </span>
                                <input type="text" id="search-input" placeholder="Search by name, ID, or factory..."
                                    class="input-glass w-full" style="padding-left: 36px;"
                                    oninput="App.ui.handleSearch(this.value)"
                                    aria-label="Search employees by name, ID, or factory">
                            </div>
                        </div>
                    </div>

                    <!-- Unified Employee Type Tabs (Replaces redundant tabs) -->
                    <div class="type-filter-tabs mb-lg flex gap-sm flex-wrap" id="type-filter-tabs">
                        <button class="btn btn-glass type-tab active flex-1" data-type="all"
                            data-action="ui.filterByType">
                            <span class="tab-label">全員 (All)</span>
                            <span class="badge badge-primary ml-sm" id="count-all">0</span>
                        </button>
                        <button class="btn btn-glass type-tab flex-1" data-type="genzai" data-action="ui.filterByType">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" class="mr-sm">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            <span class="tab-label">派遣 Dispatch</span>
                            <span class="badge badge-info ml-sm" id="count-genzai">0</span>
                        </button>
                        <button class="btn btn-glass type-tab flex-1" data-type="ukeoi" data-action="ui.filterByType">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" class="mr-sm">
                                <path
                                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                                </path>
                            </svg>
                            <span class="tab-label">請負 Contract</span>
                            <span class="badge badge-success ml-sm" id="count-ukeoi">0</span>
                        </button>
                        <button class="btn btn-glass type-tab flex-1" data-type="staff" data-action="ui.filterByType">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" class="mr-sm">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span class="tab-label">社員 Staff</span>
                            <span class="badge badge-warning ml-sm" id="count-staff">0</span>
                        </button>
                    </div>

                    <!-- Summary Cards by Type (v2.4 Pro Max Style) -->
                    <div class="bento-grid gap-md mb-lg grid-4-cols">
                        <!-- Haken Stats -->
                        <div class="glass-panel p-md hover-lift relative overflow-hidden group">
                            <div
                                class="absolute top-0 left-0 w-1 h-full bg-info opacity-50 group-hover:opacity-100 transition-opacity">
                            </div>
                            <div class="flex-between mb-sm">
                                <span class="stat-label text-xs uppercase tracking-wider text-muted font-semibold">派遣
                                    Dispatch</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="text-info opacity-70">
                                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                </svg>
                            </div>
                            <div class="stat-value text-2xl font-bold text-info-500 font-mono tracking-tight"
                                id="haken-used">0</div>
                            <div class="text-xs text-muted mt-1 opacity-70">Days Used</div>
                        </div>

                        <!-- Ukeoi Stats -->
                        <div class="glass-panel p-md hover-lift relative overflow-hidden group">
                            <div
                                class="absolute top-0 left-0 w-1 h-full bg-success opacity-50 group-hover:opacity-100 transition-opacity">
                            </div>
                            <div class="flex-between mb-sm">
                                <span class="stat-label text-xs uppercase tracking-wider text-muted font-semibold">請負
                                    Contract</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="text-success opacity-70">
                                    <path
                                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                                    </path>
                                </svg>
                            </div>
                            <div class="stat-value text-2xl font-bold text-success-500 font-mono tracking-tight"
                                id="ukeoi-used">0</div>
                            <div class="text-xs text-muted mt-1 opacity-70">Days Used</div>
                        </div>

                        <!-- Staff Stats -->
                        <div class="glass-panel p-md hover-lift relative overflow-hidden group">
                            <div
                                class="absolute top-0 left-0 w-1 h-full bg-warning opacity-50 group-hover:opacity-100 transition-opacity">
                            </div>
                            <div class="flex-between mb-sm">
                                <span class="stat-label text-xs uppercase tracking-wider text-muted font-semibold">社員
                                    Staff</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="text-warning opacity-70">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <div class="stat-value text-2xl font-bold text-warning-500 font-mono tracking-tight"
                                id="staff-used">0</div>
                            <div class="text-xs text-muted mt-1 opacity-70">Days Used</div>
                        </div>

                        <!-- Total Stats -->
                        <div class="glass-panel p-md hover-lift relative overflow-hidden group">
                            <div
                                class="absolute top-0 left-0 w-1 h-full bg-primary opacity-50 group-hover:opacity-100 transition-opacity">
                            </div>
                            <div class="flex-between mb-sm">
                                <span class="stat-label text-xs uppercase tracking-wider text-muted font-semibold">Total
                                    Usage</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="text-primary opacity-70">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="stat-value text-2xl font-bold text-primary-500 font-mono tracking-tight"
                                id="total-type-used">0</div>
                            <div class="text-xs text-muted mt-1 opacity-70">All Employees</div>
                        </div>
                    </div>

                    <!-- Bulk Edit Toolbar (v2.3) -->
                    <div class="bulk-edit-toolbar glass-panel border-info" id="bulk-edit-toolbar">
                        <div class="flex-center gap-md">
                            <span class="bulk-edit-toolbar-count badge badge-info">
                                <span id="bulk-selected-count">0</span> 名選択中
                            </span>
                            <button class="btn btn-sm btn-primary flex-center gap-xs" data-action="bulkEdit.openModal">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M12 20h9"></path>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                </svg>
                                一括編集
                            </button>
                            <button class="btn btn-sm btn-glass flex-center gap-xs"
                                data-action="bulkEdit.clearSelection">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                選択解除
                            </button>
                        </div>
                    </div>

                    <div class="overflow-auto max-h-60vh">
                        <table class="modern-table" aria-labelledby="employees-table-caption">
                            <caption id="employees-table-caption" class="sr-only">従業員有給休暇データ表</caption>
                            <thead>
                                <tr>
                                    <th scope="col" class="table-checkbox w-10">
                                        <div class="flex-center">
                                            <input type="checkbox" id="select-all-checkbox"
                                                onchange="App.bulkEdit.toggleSelectAll(this.checked)" title="全選択/解除">
                                        </div>
                                    </th>
                                    <th scope="col" class="sortable cursor-pointer group" data-sort="id">
                                        <div class="flex items-center gap-1">
                                            <span>ID</span>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                class="text-muted opacity-50 group-hover:opacity-100">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </th>
                                    <th scope="col" class="sortable cursor-pointer group" data-sort="name">
                                        <div class="flex items-center gap-1">
                                            <span>Employee</span>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                class="text-muted opacity-50 group-hover:opacity-100">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Factory/Business</th>
                                    <th scope="col" class="text-right">Granted</th>
                                    <th scope="col" class="text-right">Used</th>
                                    <th scope="col" class="text-right">Balance</th>
                                    <th scope="col" class="text-right">Rate</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Skeleton loading rows -->
                                <tr class="skeleton-row">
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-60">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-100">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-50">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-120">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-40">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-40">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-40">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-50">
                                        </div>
                                    </td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-55">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-90">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-45">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-110">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-35">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-35">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-35">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-45">
                                        </div>
                                    </td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-65">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-95">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-55">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-100">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-38">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-38">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-38">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text skeleton skeleton-w-48">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: FACTORIES -->
            <div class="view-section d-none" id="view-factories">
                <div class="glass-panel p-md h-600">
                    <h3 class="stat-label mb-lg">Usage by Factory</h3>
                    <div class="chart-container-lg">
                        <div id="chart-factories"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: REQUESTS (申請) -->
            <div class="view-section d-none" id="view-requests">
                <div class="bento-grid">
                    <!-- New Request Form -->
                    <div class="glass-panel col-span-2 p-lg">
                        <h3 class="mb-2xl text-xl">
                            📝 新規有給休暇申請
                            <span class="text-xs text-muted ml-sm">New Leave
                                Request</span>
                        </h3>

                        <div id="request-form">
                            <!-- Progress Steps -->
                            <div class="progress-steps">
                                <div class="progress-step active" id="step-1">
                                    <div class="progress-step-number">1</div>
                                    <div class="progress-step-label">従業員選択</div>
                                </div>
                                <div class="progress-step" id="step-2">
                                    <div class="progress-step-number">2</div>
                                    <div class="progress-step-label">日程・種類</div>
                                </div>
                                <div class="progress-step" id="step-3">
                                    <div class="progress-step-number">3</div>
                                    <div class="progress-step-label">確認・送信</div>
                                </div>
                            </div>

                            <!-- SECTION 1: Employee Selection -->
                            <div class="form-section">
                                <div class="form-section-title">👤 従業員を選択</div>

                                <div class="form-group">
                                    <label for="factory-filter">🏭 工場で絞込み (Filter by Factory)</label>
                                    <select class="input-glass w-full" id="factory-filter"
                                        onchange="App.requests.filterByFactory()">
                                        <option value="">すべての工場 (All Factories)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="emp-search" class="required">🔍 従業員を検索 (Search Employee)</label>
                                    <input class="input-glass w-full" type="text" id="emp-search"
                                        placeholder="名前または社員番号で検索..." oninput="App.requests.searchEmployee(this.value)"
                                        aria-describedby="emp-search-validation">
                                    <div id="emp-search-validation" class="validation-message"></div>
                                    <div id="emp-search-results" class="mt-sm max-h-200"></div>
                                </div>
                            </div>

                            <!-- Selected Employee Info -->
                            <div id="selected-emp-info" class="d-none mb-xl bg-cyan-highlight">
                                <div class="flex-between">
                                    <div>
                                        <div id="selected-emp-name" class="font-semibold text-lg"></div>
                                        <div id="selected-emp-details" class="text-muted text-sm">
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="stat-label">残り日数</div>
                                        <div id="selected-emp-balance" class="text-2xl font-bold text-success">
                                        </div>
                                    </div>
                                </div>
                                <!-- Hourly wage info (shown when available) -->
                                <div id="hourly-wage-info" class="d-none mt-md pt-md border-top-subtle">
                                    <div class="flex-between">
                                        <div>
                                            <span class="stat-label">時給 (Hourly Wage):</span>
                                            <span id="selected-emp-wage" class="font-semibold text-cyan ml-sm"></span>
                                        </div>
                                        <div>
                                            <span class="stat-label">時間残高:</span>
                                            <span id="selected-emp-hours"
                                                class="font-semibold text-warning ml-sm"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Yukyu History Table (2 years) -->
                                <div id="yukyu-history-table" class="mt-lg pt-lg border-top-subtle">
                                    <div class="mb-md">
                                        <span class="stat-label">📊 年度別有給履歴 (2年分)</span>
                                    </div>
                                    <table class="w-full text-sm border-collapse"
                                        aria-labelledby="yukyu-history-caption">
                                        <caption id="yukyu-history-caption" class="sr-only">年度別有給履歴表 - Annual paid leave
                                            history table (2 years)</caption>
                                        <thead>
                                            <tr class="table-header-highlight">
                                                <th scope="col" class="p-sm text-left rounded-tl">
                                                    年度</th>
                                                <th scope="col" class="p-sm text-center">付与日数</th>
                                                <th scope="col" class="p-sm text-center">使用日数</th>
                                                <th scope="col" class="p-sm text-center">残日数</th>
                                                <th scope="col" class="p-sm text-center rounded-tr">
                                                    消化率</th>
                                            </tr>
                                        </thead>
                                        <tbody id="yukyu-history-tbody">
                                            <tr>
                                                <td colspan="5" class="p-md text-center text-muted">
                                                    従業員を選択してください
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Usage History (dates) -->
                                <div id="usage-history-container" class="d-none mt-md pt-md border-top-subtle">
                                    <div class="mb-sm">
                                        <span class="stat-label">📅 使用履歴 (Usage History)</span>
                                        <button type="button" data-action="requests.toggleUsageHistory"
                                            class="ml-sm text-xs text-muted cursor-pointer input-compact">
                                            詳細を表示
                                        </button>
                                    </div>
                                    <div id="usage-history-summary" class="text-sm text-muted">
                                    </div>
                                    <div id="usage-history-detail" class="d-none mt-sm max-h-200">
                                    </div>
                                </div>
                            </div>

                            <!-- SECTION 2: Date & Type -->
                            <div class="form-section">
                                <div class="form-section-title">📅 日程と種類</div>

                                <div class="d-grid gap-md grid-2-cols">
                                    <div class="form-group">
                                        <label for="start-date" class="required">開始日 (Start Date)</label>
                                        <input class="input-glass w-full" type="date" id="start-date"
                                            onchange="App.requests.validateDates()"
                                            aria-describedby="start-date-validation">
                                        <div id="start-date-validation" class="validation-message"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="end-date" class="required">終了日 (End Date)</label>
                                        <input class="input-glass w-full" type="date" id="end-date"
                                            onchange="App.requests.validateDates()"
                                            aria-describedby="end-date-validation">
                                        <div id="end-date-validation" class="validation-message"></div>
                                    </div>
                                </div>

                                <div class="d-grid gap-md grid-2-cols">
                                    <div class="form-group">
                                        <label for="leave-type" class="required">種類 (Type)</label>
                                        <select class="input-glass w-full" id="leave-type"
                                            onchange="App.requests.toggleLeaveType()">
                                            <option value="full">全日休暇 (Full Day)</option>
                                            <option value="half_am">午前半休 (AM Half)</option>
                                            <option value="half_pm">午後半休 (PM Half)</option>
                                            <option value="hourly">時間休 (Hourly)</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="days-input-container">
                                        <label for="days-requested" class="required">日数 (Days)</label>
                                        <input class="input-glass w-full" type="number" id="days-requested" min="0.5"
                                            step="0.5" value="1" oninput="App.requests.validateDays()"
                                            aria-describedby="days-validation">
                                        <div id="days-validation" class="validation-message"></div>
                                    </div>
                                    <div class="form-group d-none" id="hours-input-container">
                                        <label for="hours-requested" class="required">時間数 (Hours)</label>
                                        <input class="input-glass w-full" type="number" id="hours-requested" min="1"
                                            max="7" step="1" value="1"
                                            oninput="App.requests.updateCostEstimate(); App.requests.validateHours();"
                                            aria-describedby="hours-validation hours-hint">
                                        <div id="hours-validation" class="validation-message"></div>
                                        <div id="hours-hint" class="text-xs text-muted mt-xs">
                                            ※ 1日最大7時間まで</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cost Estimate (shown for hourly leave) -->
                            <div id="cost-estimate-container" class="d-none mb-xl info-card-warning">
                                <div class="flex-between">
                                    <span class="stat-label">💰 見積コスト (Estimated Cost):</span>
                                    <span id="cost-estimate" class="text-xl font-bold text-warning"></span>
                                </div>
                            </div>

                            <!-- SECTION 3: Reason -->
                            <div class="form-section">
                                <div class="form-section-title">📝 理由</div>
                                <div class="form-group">
                                    <label for="leave-reason">理由 (Reason) - 任意</label>
                                    <textarea class="input-glass w-full min-h-80 textarea-resizable" id="leave-reason"
                                        placeholder="私用、通院、旅行など..." maxlength="200"
                                        oninput="App.requests.updateCharCounter()"
                                        aria-describedby="reason-char-counter"></textarea>
                                    <div class="char-counter" id="reason-char-counter">0 / 200</div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <button class="btn btn-primary w-full p-md" id="submit-btn"
                                data-action="requests.showConfirmation">
                                ✓ 内容を確認する (Review & Submit)
                            </button>
                        </div>
                    </div>

                    <!-- Pending Requests -->
                    <div class="glass-panel col-span-2 p-lg">
                        <div class="flex-between mb-lg">
                            <h3 class="text-xl">
                                ⏳ 承認待ち
                                <span class="text-xs text-muted ml-sm">Pending
                                    Approvals</span>
                            </h3>
                            <button class="btn btn-glass" data-action="requests.loadPending">
                                🔄 更新
                            </button>
                        </div>

                        <div id="pending-requests" class="overflow-y-auto max-h-400">
                            <div class="empty-state">
                                Loading pending requests...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Request History -->
                <div class="glass-panel p-lg mt-2xl">
                    <h3 class="mb-2xl text-xl">
                        📋 申請履歴
                        <span class="text-xs text-muted ml-sm">Request
                            History</span>
                    </h3>
                    <div class="overflow-auto">
                        <table class="modern-table" aria-labelledby="requests-history-caption">
                            <caption id="requests-history-caption" class="sr-only">休暇申請履歴表 - Leave request history table
                            </caption>
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">従業員</th>
                                    <th scope="col">期間</th>
                                    <th scope="col">日数</th>
                                    <th scope="col">理由</th>
                                    <th scope="col">ステータス</th>
                                    <th scope="col">申請日</th>
                                    <th scope="col">操作</th>
                                </tr>
                            </thead>
                            <tbody id="requests-history">
                                <tr>
                                    <td colspan="8" class="text-center p-xl">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: COMPLIANCE -->
            <div class="view-section d-none" id="view-compliance">
                <div class="bento-grid">
                    <!-- 5 Day Compliance -->
                    <div class="glass-panel col-span-2 p-lg">
                        <div class="flex-between mb-lg">
                            <h3 class="text-xl">
                                📊 5日取得義務 チェック
                                <span class="text-xs text-muted ml-sm">5-Day
                                    Compliance Check</span>
                            </h3>
                            <button class="btn btn-primary" data-action="compliance.check5Day">
                                🔍 チェック実行
                            </button>
                        </div>

                        <div id="compliance-summary" class="d-grid gap-md mb-2xl grid-4-cols">
                            <div class="stat-card text-center">
                                <div class="stat-label">対象者</div>
                                <div class="stat-value" id="comp-total">-</div>
                            </div>
                            <div class="stat-card text-center border-success">
                                <div class="stat-label">達成</div>
                                <div class="stat-value text-success" id="comp-compliant">-
                                </div>
                            </div>
                            <div class="stat-card text-center border-warning">
                                <div class="stat-label">要注意</div>
                                <div class="stat-value text-warning" id="comp-atrisk">-</div>
                            </div>
                            <div class="stat-card text-center border-danger">
                                <div class="stat-label">未達成</div>
                                <div class="stat-value text-danger" id="comp-noncompliant">-
                                </div>
                            </div>
                        </div>

                        <div id="compliance-list" class="overflow-y-auto max-h-300">
                            <div class="empty-state">
                                Click "チェック実行" to check compliance
                            </div>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div class="glass-panel col-span-2 p-lg">
                        <div class="flex-between mb-lg">
                            <h3 class="text-xl">
                                🚨 アラート
                                <span class="text-xs text-muted ml-sm">Compliance
                                    Alerts</span>
                            </h3>
                            <button class="btn btn-glass" data-action="compliance.loadAlerts">
                                🔄 更新
                            </button>
                        </div>

                        <div id="alerts-container" class="overflow-y-auto max-h-400">
                            <div class="empty-state">
                                Loading alerts...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Annual Ledger -->
                <div class="glass-panel p-lg mt-2xl">
                    <div class="flex-between mb-lg">
                        <h3 class="text-xl">
                            📒 年次有給休暇管理簿
                            <span class="text-xs text-muted ml-sm">Annual
                                Leave Ledger (Required by Law)</span>
                        </h3>
                        <div class="flex-center gap-sm">
                            <button class="btn btn-glass" data-action="compliance.loadLedger">
                                📄 表示
                            </button>
                            <button class="btn btn-primary" data-action="compliance.exportLedger" data-format="csv">
                                💾 CSV出力
                            </button>
                        </div>
                    </div>

                    <div id="ledger-container" class="overflow-auto max-h-400">
                        <div class="empty-state">
                            Click "表示" to load the annual ledger
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CALENDAR -->
            <div class="view-section d-none" id="view-calendar">
                <div class="bento-grid">
                    <!-- Calendar Controls -->
                    <div class="glass-panel col-span-4 p-md">
                        <div class="flex-between mb-lg">
                            <div class="flex-center gap-md">
                                <button class="btn btn-glass" data-action="calendar.prevMonth">◀</button>
                                <h3 id="calendar-month-title" class="text-2xl text-center min-w-200">
                                    2025年 12月
                                </h3>
                                <button class="btn btn-glass" data-action="calendar.nextMonth">▶</button>
                            </div>
                            <div class="flex-center gap-sm">
                                <button class="btn btn-glass" data-action="calendar.goToToday">今日</button>
                                <button class="btn btn-primary" data-action="calendar.loadEvents"
                                    aria-label="カレンダーを更新">🔄
                                    更新</button>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="flex-center gap-lg mb-lg text-sm">
                            <span><span class="legend-box legend-box-cyan"></span>全日休暇</span>
                            <span><span class="legend-box legend-box-cyan-dark"></span>午前半休</span>
                            <span><span class="legend-box legend-box-cyan-light"></span>午後半休</span>
                            <span><span class="legend-box legend-box-warning"></span>時間休</span>
                            <span><span class="legend-box legend-box-success"></span>使用日</span>
                        </div>

                        <!-- Calendar Grid -->
                        <div id="calendar-grid" class="calendar-grid">
                            <!-- Header -->
                            <div class="calendar-header-cell">日</div>
                            <div class="calendar-header-cell">月</div>
                            <div class="calendar-header-cell">火</div>
                            <div class="calendar-header-cell">水</div>
                            <div class="calendar-header-cell">木</div>
                            <div class="calendar-header-cell">金</div>
                            <div class="calendar-header-cell">土</div>
                            <!-- Days will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Day Detail Panel -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="mb-lg text-lg">
                            📋 選択日の詳細
                            <span id="selected-date-display" class="text-cyan ml-sm">-</span>
                        </h3>
                        <div id="day-detail-container" class="overflow-y-auto max-h-300">
                            <div class="empty-state">
                                日付をクリックして詳細を表示
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Summary -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="mb-lg text-lg">📊 月間サマリー</h3>
                        <div id="monthly-summary-container">
                            <div class="d-grid gap-md grid-2-cols">
                                <div class="stat-card text-center p-md">
                                    <div class="stat-label">休暇取得者数</div>
                                    <div class="stat-value text-2xl" id="cal-month-employees">-
                                    </div>
                                </div>
                                <div class="stat-card text-center p-md">
                                    <div class="stat-label">総取得日数</div>
                                    <div class="stat-value text-2xl" id="cal-month-days">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: ANALYTICS -->
            <div class="view-section d-none" id="view-analytics">
                <div class="bento-grid">
                    <!-- Summary Cards -->
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">総従業員数</div>
                        <div class="stat-value" id="ana-total-emp">-</div>
                    </div>
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">総付与日数</div>
                        <div class="stat-value text-cyan" id="ana-total-granted">-</div>
                    </div>
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">総使用日数</div>
                        <div class="stat-value text-success" id="ana-total-used">-</div>
                    </div>
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">平均消化率</div>
                        <div class="stat-value text-warning" id="ana-avg-rate">-</div>
                    </div>

                    <!-- Department Chart -->
                    <div class="glass-panel col-span-2 p-md h-400">
                        <h3 class="stat-label mb-lg">部門別使用日数</h3>
                        <div class="chart-container-sm">
                            <canvas id="chart-department"></canvas>
                        </div>
                    </div>

                    <!-- Employee Type Chart -->
                    <div class="glass-panel col-span-2 p-md h-400">
                        <h3 class="stat-label mb-lg">従業員タイプ別</h3>
                        <div class="chart-container-sm">
                            <canvas id="chart-emp-type"></canvas>
                        </div>
                    </div>

                    <!-- Top Users -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="stat-label mb-lg">🏆 Top 10 使用者</h3>
                        <div id="top-users-list" class="overflow-y-auto max-h-300"></div>
                    </div>

                    <!-- High Balance -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="stat-label mb-lg">⚠️ 残日数が多い従業員</h3>
                        <div id="high-balance-list" class="overflow-y-auto max-h-300"></div>
                    </div>

                    <!-- Predictions -->
                    <div class="glass-panel col-span-4 p-md">
                        <div class="flex-between mb-lg">
                            <h3 class="stat-label">📈 年末予測・5日義務達成リスク</h3>
                            <button class="btn btn-glass" data-action="analytics.loadPredictions" aria-label="予測を更新">🔄
                                更新</button>
                        </div>
                        <div id="predictions-container">
                            <div class="d-grid gap-md mb-lg grid-4-cols">
                                <div class="stat-card text-center p-md">
                                    <div class="stat-label">現在月</div>
                                    <div id="pred-current-month" class="text-2xl font-bold">-
                                    </div>
                                </div>
                                <div class="stat-card text-center p-md">
                                    <div class="stat-label">残り月数</div>
                                    <div id="pred-remaining-months" class="text-2xl font-bold">-</div>
                                </div>
                                <div class="stat-card text-center p-md">
                                    <div class="stat-label">月平均使用</div>
                                    <div id="pred-avg-monthly" class="text-2xl font-bold">-
                                    </div>
                                </div>
                                <div class="stat-card text-center p-md border-danger">
                                    <div class="stat-label">5日未達成リスク</div>
                                    <div id="pred-at-risk" class="text-2xl font-bold text-danger">-
                                    </div>
                                </div>
                            </div>
                            <div id="at-risk-employees" class="max-h-200"></div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="glass-panel p-md mt-2xl">
                    <h3 class="stat-label mb-lg">📥 データエクスポート</h3>
                    <div class="flex-center gap-md flex-wrap">
                        <button class="btn btn-primary" data-action="analytics.exportExcel" data-type="employees">
                            📊 従業員データ (Excel)
                        </button>
                        <button class="btn btn-glass" data-action="analytics.exportExcel" data-type="requests">
                            📝 申請一覧 (Excel)
                        </button>
                        <button class="btn btn-glass" data-action="analytics.exportExcel" data-type="compliance">
                            ✅ 管理簿 (Excel)
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: MONTHLY REPORTS -->
            <div class="view-section d-none" id="view-reports">
                <div class="bento-grid">
                    <!-- Date Selector with Tabs -->
                    <div class="glass-panel col-span-4 p-md">
                        <div class="flex-between mb-xl flex-wrap gap-md">
                            <h3 class="text-xl">📋 レポート期間</h3>
                            <button class="btn btn-export" data-action="reports.exportReport">
                                📥 Excel出力
                            </button>
                        </div>

                        <!-- Tab Selector -->
                        <div class="tab-container mb-xl">
                            <button class="tab-btn active" id="tab-monthly" data-action="reports.setMode"
                                data-mode="monthly">
                                📅 月次 (21日〜20日)
                            </button>
                            <button class="tab-btn" id="tab-custom" data-action="reports.setMode" data-mode="custom">
                                🔧 期間指定
                            </button>
                        </div>

                        <!-- Monthly Mode -->
                        <div id="monthly-selector" class="flex gap-md align-end mb-lg flex-wrap">
                            <div>
                                <label for="report-year" class="sr-only">年度選択</label>
                                <select id="report-year" class="input-glass w-120"
                                    onchange="App.reports.loadMonthList()" aria-label="年度を選択">
                                </select>
                            </div>
                            <div>
                                <label for="report-month" class="sr-only">月度選択</label>
                                <select id="report-month" class="input-glass w-120" onchange="App.reports.loadReport()"
                                    aria-label="月度を選択">
                                    <option value="1">1月度</option>
                                    <option value="2">2月度</option>
                                    <option value="3">3月度</option>
                                    <option value="4">4月度</option>
                                    <option value="5">5月度</option>
                                    <option value="6">6月度</option>
                                    <option value="7">7月度</option>
                                    <option value="8">8月度</option>
                                    <option value="9">9月度</option>
                                    <option value="10">10月度</option>
                                    <option value="11">11月度</option>
                                    <option value="12">12月度</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" data-action="reports.loadReport">🔍 表示</button>
                        </div>

                        <!-- Custom Mode -->
                        <div id="custom-selector" class="d-none mb-lg">
                            <div class="flex gap-md align-end flex-wrap">
                                <div>
                                    <label class="stat-label d-block mb-xs text-xs" for="report-start-date">開始日</label>
                                    <input type="date" id="report-start-date" class="input-glass w-160">
                                </div>
                                <div class="pb-md" aria-hidden="true">
                                    <span class="text-xl text-muted">〜</span>
                                </div>
                                <div>
                                    <label class="stat-label d-block mb-xs text-xs" for="report-end-date">終了日</label>
                                    <input type="date" id="report-end-date" class="input-glass w-160">
                                </div>
                                <button class="btn btn-primary" data-action="reports.loadCustomReport">🔍
                                    表示</button>
                            </div>
                            <div class="mt-md text-sm text-muted">
                                ※ 複数月にまたがる期間もOK（例: 1/16 〜 2/20）
                            </div>
                        </div>

                        <!-- Period Display -->
                        <div id="report-period-display" class="text-center p-md bg-cyan-subtle rounded">
                            <span class="text-xl font-semibold" id="report-period-label">-</span>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">取得者数</div>
                        <div class="stat-value" id="rpt-emp-count">-</div>
                    </div>
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">総取得日数</div>
                        <div class="stat-value text-cyan" id="rpt-total-days">-</div>
                    </div>
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">総取得時間</div>
                        <div class="stat-value text-warning" id="rpt-total-hours">-</div>
                    </div>
                    <div class="glass-panel stat-card col-span-1">
                        <div class="stat-label">1人平均</div>
                        <div class="stat-value text-success" id="rpt-avg-days">-</div>
                    </div>

                    <!-- Employee List -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="stat-label mb-lg">👥 取得者一覧</h3>
                        <div id="report-employee-list" class="overflow-y-auto max-h-400">
                            <div class="empty-state">
                                月を選択してレポートを表示
                            </div>
                        </div>
                    </div>

                    <!-- Factory Summary -->
                    <div class="glass-panel col-span-2 p-md">
                        <h3 class="stat-label mb-lg">🏭 派遣先別集計</h3>
                        <div id="report-factory-list" class="overflow-y-auto max-h-400">
                            <div class="empty-state">
                                月を選択してレポートを表示
                            </div>
                        </div>
                    </div>

                    <!-- Daily Breakdown -->
                    <div class="glass-panel col-span-4 p-md">
                        <h3 class="stat-label mb-lg">📅 日別取得状況</h3>
                        <div id="report-daily-grid" class="d-grid gap-sm overflow-y-auto grid-auto-fill">
                            <div class="empty-state col-span-full">
                                月を選択してレポートを表示
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Year Overview -->
                <div class="glass-panel p-md mt-2xl">
                    <h3 class="stat-label mb-lg">📊 年間月別サマリー</h3>
                    <div class="overflow-auto">
                        <table class="modern-table" aria-labelledby="year-summary-caption">
                            <caption id="year-summary-caption" class="sr-only">年間月別サマリー表 - Annual monthly summary table
                            </caption>
                            <thead>
                                <tr>
                                    <th scope="col">月度</th>
                                    <th scope="col">期間</th>
                                    <th scope="col">取得者数</th>
                                    <th scope="col">総日数</th>
                                    <th scope="col">詳細</th>
                                </tr>
                            </thead>
                            <tbody id="report-year-summary">
                                <tr>
                                    <td colspan="5" class="text-center p-xl">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div class="view-section d-none" id="view-settings">
                <div class="glass-panel p-lg">
                    <h3 class="mb-2xl text-xl">⚙️ システム設定</h3>

                    <div class="d-grid gap-xl">
                        <!-- System Status -->
                        <div>
                            <h4 class="stat-label mb-lg">システム状態</h4>
                            <div id="system-status" class="d-grid gap-md grid-3-cols-fixed">
                                <div class="stat-card text-center">
                                    <div class="stat-label">Database Size</div>
                                    <div class="stat-value" id="sys-db-size">-</div>
                                </div>
                                <div class="stat-card text-center">
                                    <div class="stat-label">Total Employees</div>
                                    <div class="stat-value" id="sys-emp-count">-</div>
                                </div>
                                <div class="stat-card text-center">
                                    <div class="stat-label">Health Status</div>
                                    <div class="stat-value text-success" id="sys-health">-
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div>
                            <h4 class="stat-label mb-lg">データ管理</h4>
                            <div class="flex gap-md flex-wrap">
                                <button class="btn btn-glass" data-action="settings.loadSnapshot">
                                    📊 Snapshot更新
                                </button>
                                <button class="btn btn-glass" data-action="settings.viewAuditLog">
                                    📜 監査ログ
                                </button>
                                <button class="btn btn-glass bg-primary-light" data-action="data.sync">
                                    ⚡ データ同期
                                </button>
                            </div>
                        </div>

                        <!-- Backup Management -->
                        <div>
                            <h4 class="stat-label mb-lg">📦 バックアップ管理</h4>
                            <div class="flex gap-md flex-wrap">
                                <button class="btn btn-primary" data-action="backup.create">
                                    📦 バックアップ作成
                                </button>
                                <button class="btn btn-glass" data-action="backup.showBackupList">
                                    📋 バックアップ一覧
                                </button>
                            </div>
                            <div class="mt-md text-sm text-muted">
                                ※ サーバー起動時に自動バックアップが作成されます。最大10件保持。
                            </div>
                        </div>

                        <!-- API Info -->
                        <div>
                            <h4 class="stat-label mb-lg">API情報</h4>
                            <div class="p-md rounded text-sm bg-code">
                                <div class="text-muted">Base URL:</div>
                                <div class="text-cyan">/api</div>
                                <div class="text-muted mt-sm">Documentation:</div>
                                <div><a href="/docs" target="_blank" class="text-cyan">/docs</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- UI Elements -->
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <div>読み込み中</div>
    </div>

    <div class="toast-container" role="status" aria-live="polite" aria-atomic="true" id="toast-container"></div>

    <!-- Simple Modal for Details -->
    <div class="loader-overlay bg-overlay-dark" id="detail-modal" role="dialog" aria-modal="true"
        aria-labelledby="modal-title">
        <div class="glass-panel modal-content-container">
            <button class="btn modal-close-btn" data-action="ui.closeModal" aria-label="Close modal">✕</button>
            <div class="p-xl">
                <h2 id="modal-title" class="mb-lg">Employee Details</h2>
                <div id="modal-content"></div>
            </div>
        </div>
    </div>

    <!-- Flatpickr Script -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ja.js"></script>

    <!-- Flatpickr Initialization -->
    <script>
        // Get current theme dynamically
        const getCurrentTheme = () => {
            return document.documentElement.getAttribute('data-theme') || 'dark';
        };

        document.addEventListener('DOMContentLoaded', function () {
            // Common Flatpickr configuration
            const flatpickrConfig = {
                locale: 'ja',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'Y年m月d日 (D)',
                allowInput: true,
                clickOpens: true,
                theme: getCurrentTheme(), // Tema dinámico basado en data-theme
                position: 'auto',
                animate: true,
                monthSelectorType: 'dropdown',
                shorthandCurrentMonth: false,
                yearSelectorType: 'dropdown',
                disableMobile: false,
                onReady: function (selectedDates, dateStr, instance) {
                    // Add custom icon to the input wrapper
                    const input = instance.input;
                    if (!input.parentElement.querySelector('.flatpickr-icon')) {
                        const icon = document.createElement('span');
                        icon.className = 'flatpickr-icon';
                        icon.textContent = '📅';
                        icon.style.cssText = 'position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 1.2rem; opacity: 0.6;';
                        input.parentElement.style.position = 'relative';
                        input.parentElement.appendChild(icon);
                    }
                },
                onChange: function (selectedDates, dateStr, instance) {
                    // Trigger the original onchange event if exists
                    const event = new Event('change', { bubbles: true });
                    instance.input.dispatchEvent(event);
                }
            };

            // Initialize Start Date picker
            const startDateInput = document.getElementById('start-date');
            if (startDateInput) {
                const startDatePicker = flatpickr(startDateInput, {
                    ...flatpickrConfig,
                    onChange: function (selectedDates, dateStr, instance) {
                        // Update end date minimum
                        if (endDatePicker && selectedDates.length > 0) {
                            endDatePicker.set('minDate', selectedDates[0]);
                        }
                        // Trigger original validation
                        if (typeof App !== 'undefined' && App.requests && App.requests.validateDates) {
                            App.requests.validateDates();
                        }
                    }
                });

                window.startDatePicker = startDatePicker;
            }

            // Initialize End Date picker
            const endDateInput = document.getElementById('end-date');
            if (endDateInput) {
                const endDatePicker = flatpickr(endDateInput, {
                    ...flatpickrConfig,
                    onChange: function (selectedDates, dateStr, instance) {
                        // Update start date maximum
                        if (startDatePicker && selectedDates.length > 0) {
                            startDatePicker.set('maxDate', selectedDates[0]);
                        }
                        // Trigger original validation
                        if (typeof App !== 'undefined' && App.requests && App.requests.validateDates) {
                            App.requests.validateDates();
                        }
                    }
                });

                window.endDatePicker = endDatePicker;
            }

            // Initialize Report Date pickers (for custom report range)
            const reportStartDate = document.getElementById('report-start-date');
            if (reportStartDate) {
                const reportStartPicker = flatpickr(reportStartDate, {
                    ...flatpickrConfig,
                    onChange: function (selectedDates, dateStr, instance) {
                        if (reportEndPicker && selectedDates.length > 0) {
                            reportEndPicker.set('minDate', selectedDates[0]);
                        }
                    }
                });
                window.reportStartPicker = reportStartPicker;
            }

            const reportEndDate = document.getElementById('report-end-date');
            if (reportEndDate) {
                const reportEndPicker = flatpickr(reportEndDate, {
                    ...flatpickrConfig,
                    onChange: function (selectedDates, dateStr, instance) {
                        if (reportStartPicker && selectedDates.length > 0) {
                            reportStartPicker.set('maxDate', selectedDates[0]);
                        }
                    }
                });
                window.reportEndPicker = reportEndPicker;
            }

            console.log('✅ Flatpickr date pickers initialized with Japanese locale and custom theme');
        });
    </script>

    <script src="/static/js/app.js?v=20260210-1"></script>

    <!-- FASE 4.2: Modern Component Integration Bridge (Non-Breaking) -->
    <script src="/static/js/modern-integration.js?v=20260117" defer></script>

    <!-- Modern UI Bootstrap - Connects static/src/ with legacy app.js -->
    <script type="module">
        import { initModernUI, loadComponents, CONFIG, FEATURES } from '/static/src/bootstrap.js';

        // Wait for legacy App to be available
        function waitForApp(timeout = 5000) {
            return new Promise((resolve, reject) => {
                if (window.App) {
                    resolve(window.App);
                    return;
                }
                const start = Date.now();
                const check = setInterval(() => {
                    if (window.App) {
                        clearInterval(check);
                        resolve(window.App);
                    } else if (Date.now() - start > timeout) {
                        clearInterval(check);
                        reject(new Error('App not found'));
                    }
                }, 50);
            });
        }

        // Initialize when App is ready
        waitForApp().then(async (App) => {
            // Initialize modern UI and attach to legacy App
            const result = await initModernUI(App);

            if (result.success) {
                console.log('[YuKyu] Modern UI components loaded');
                console.log('[YuKyu] Access via App.components.Modal, App.components.Alert, etc.');

                // Pre-load commonly used components for faster access
                const components = await loadComponents([
                    'Modal', 'Alert', 'Badge', 'Loader'
                ]);

                // Expose helper for quick notifications
                window.notify = {
                    success: (msg) => App.components.Alert.success(msg),
                    error: (msg) => App.components.Alert.error(msg),
                    warning: (msg) => App.components.Alert.warning(msg),
                    info: (msg) => App.components.Alert.info(msg)
                };
            } else {
                console.warn('[YuKyu] Modern UI not available:', result.reason);
            }
        }).catch(err => {
            console.warn('[YuKyu] Legacy App not found, modern UI skipped:', err.message);
        });
    </script>

    <!-- UI Enhancements Module (Sprint 1, 2 & 3) -->
    <script type="module">
        import {
            FormValidator,
            LoadingState,
            ConfirmDialog,
            FocusTrap,
            Tooltip,
            ProgressIndicator,
            initUIEnhancements
        } from '/static/js/modules/ui-enhancements.js';

        // Expose to global scope for use in App
        window.UIEnhancements = {
            FormValidator,
            LoadingState,
            ConfirmDialog,
            FocusTrap,
            Tooltip,
            ProgressIndicator
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize tooltip system
            Tooltip.init();

            // Add tooltips to key buttons
            const tooltips = {
                'btn-sync-main': 'Excelから有給データを同期します / Sincronizar datos de vacaciones desde Excel',
                'btn-sync-genzai': '派遣社員データを同期 / Sincronizar empleados dispatch',
                'btn-sync-ukeoi': '請負社員データを同期 / Sincronizar empleados contrato',
                'year-select': '年度を選択 / Seleccionar año fiscal',
                'search-input': '名前または社員番号で検索 / Buscar por nombre o número'
            };

            Object.entries(tooltips).forEach(([id, text]) => {
                const el = document.getElementById(id);
                if (el) {
                    el.setAttribute('data-tooltip', text);
                }
            });

            // Wrap destructive actions with confirmation dialogs
            if (typeof App !== 'undefined' && App.data) {
                // Store original reset methods if they exist
                const originalMethods = {};

                // Wrap any reset/delete methods with confirmation
                const wrapWithConfirmation = (methodName, confirmMessage, dataType) => {
                    if (App.data[methodName] && typeof App.data[methodName] === 'function') {
                        originalMethods[methodName] = App.data[methodName].bind(App.data);
                        App.data[methodName] = async function (...args) {
                            const confirmed = await ConfirmDialog.confirmReset(dataType);
                            if (confirmed) {
                                return originalMethods[methodName](...args);
                            }
                        };
                    }
                };

                // Apply to known destructive methods
                wrapWithConfirmation('resetData', 'todos los datos de vacaciones');
                wrapWithConfirmation('resetGenzai', 'los datos de empleados dispatch');
                wrapWithConfirmation('resetUkeoi', 'los datos de empleados contrato');
            }

            console.log('✨ UI Enhancements v2.7 initialized');
        });
    </script>

    <!-- PWA Service Worker Registration & Offline Support -->
    <script type="module">
        import { offlineStorage, NetworkStatusManager } from '/static/js/modules/offline-storage.js';

        // Initialize offline storage globally
        window.offlineStorage = offlineStorage;

        // Service Worker Registration with Enhanced Features
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/static/sw.js');
                    console.log('[PWA] Service Worker registered:', registration.scope);

                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('[PWA] New Service Worker installing...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateToast();
                            }
                        });
                    });

                    // Request background sync permission
                    if ('sync' in registration) {
                        console.log('[PWA] Background Sync supported');
                    }

                    // Request periodic sync permission (if supported)
                    if ('periodicSync' in registration) {
                        try {
                            await registration.periodicSync.register('yukyu-periodic-sync', {
                                minInterval: 24 * 60 * 60 * 1000
                            });
                            console.log('[PWA] Periodic Sync registered');
                        } catch (err) {
                            console.log('[PWA] Periodic Sync not available:', err.message);
                        }
                    }

                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            });

            // Listen for messages from Service Worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                const { type, data } = event.data;

                switch (type) {
                    case 'QUEUE_REQUEST':
                        offlineStorage.addPendingLeaveRequest(data);
                        showOfflineQueuedToast();
                        break;

                    case 'SYNC_PENDING':
                        offlineStorage.syncPending();
                        break;

                    case 'CACHE_CLEARED':
                        console.log('[PWA] Cache cleared');
                        break;
                }
            });
        }

        // PWA Install Prompt
        let deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
            console.log('[PWA] Install prompt available');
        });

        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            hideInstallButton();
            console.log('[PWA] App installed successfully');
        });

        // PWA UI Helper Functions
        function showUpdateToast() {
            const toast = document.createElement('div');
            toast.className = 'pwa-update-toast';
            toast.innerHTML = `
                <span>New version available!</span>
                <button data-action="window.reload">Update</button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
        }

        function showOfflineQueuedToast() {
            if (window.App && window.App.showToast) {
                window.App.showToast('info', 'Request queued - will sync when online', 4000);
            }
        }

        function showInstallButton() {
            let btn = document.getElementById('pwa-install-btn');
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'pwa-install-btn';
                btn.className = 'pwa-install-btn';
                btn.innerHTML = '<span class="install-icon">+</span> Install App';
                btn.onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log('[PWA] Install prompt result:', outcome);
                        deferredPrompt = null;
                        hideInstallButton();
                    }
                };
                document.body.appendChild(btn);
            }
            btn.style.display = 'flex';
        }

        function hideInstallButton() {
            const btn = document.getElementById('pwa-install-btn');
            if (btn) btn.style.display = 'none';
        }

        // Initialize network status manager (shows online/offline indicator)
        new NetworkStatusManager();

        // Precache API data when online for offline use
        window.addEventListener('load', async () => {
            if (navigator.onLine) {
                try {
                    const year = new Date().getFullYear();
                    const response = await fetch(`/api/employees?year=${year}`);
                    if (response.ok) {
                        const data = await response.json();
                        await offlineStorage.saveEmployees(data.data || [], year);
                        console.log('[PWA] Employees data cached for offline use');
                    }
                } catch (err) {
                    console.log('[PWA] Could not precache employees:', err.message);
                }
            }
        });

        // Listen for sync complete events
        window.addEventListener('yukyu-sync-complete', (e) => {
            const { success, failed } = e.detail;
            if (window.App && window.App.showToast) {
                if (failed === 0) {
                    window.App.showToast('success', `Synced ${success} pending requests`, 4000);
                } else {
                    window.App.showToast('warning', `Synced ${success}, ${failed} failed`, 5000);
                }
            }
        });
    </script>

    <!-- PWA UI Styles -->
    <style>
        /* PWA Install Button */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transition: all 0.3s ease;
        }

        .pwa-install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
        }

        .pwa-install-btn .install-icon {
            font-size: 18px;
            font-weight: 700;
        }

        /* PWA Update Toast */
        .pwa-update-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            z-index: 10001;
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
            transition: transform 0.3s ease;
        }

        .pwa-update-toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .pwa-update-toast button {
            padding: 6px 12px;
            background: white;
            color: #7c3aed;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pwa-update-toast button:hover {
            transform: scale(1.05);
        }

        /* Light mode adjustments for PWA elements */
        [data-theme="light"] .pwa-install-btn {
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
    </style>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-title">
                ✅ 申請内容の確認
            </div>

            <div class="confirm-summary">
                <div class="confirm-row">
                    <span class="confirm-row-label">従業員</span>
                    <span class="confirm-row-value" id="confirm-employee">-</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-row-label">工場</span>
                    <span class="confirm-row-value" id="confirm-factory">-</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-row-label">期間</span>
                    <span class="confirm-row-value" id="confirm-dates">-</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-row-label">種類</span>
                    <span class="confirm-row-value" id="confirm-type">-</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-row-label">日数/時間</span>
                    <span class="confirm-row-value highlight" id="confirm-amount">-</span>
                </div>
                <div class="confirm-row d-none" id="confirm-cost-row">
                    <span class="confirm-row-label">見積コスト</span>
                    <span class="confirm-row-value text-warning" id="confirm-cost">-</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-row-label">残り日数</span>
                    <span class="confirm-row-value" id="confirm-balance">-</span>
                </div>
                <div class="confirm-row" id="confirm-reason-row">
                    <span class="confirm-row-label">理由</span>
                    <span class="confirm-row-value text-right max-w-200" id="confirm-reason">-</span>
                </div>
            </div>

            <div class="p-md bg-warning-subtle rounded mb-lg text-sm text-warning">
                ⚠️ この内容で申請を送信しますか？
            </div>

            <div class="confirm-actions">
                <button class="btn btn-glass" data-action="requests.hideConfirmation">
                    ← 戻る
                </button>
                <button class="btn btn-primary" id="confirm-submit-btn" data-action="requests.submitConfirmed">
                    📤 申請する
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Yukyu Usage Modal (v2.1 - NEW) -->
    <div id="edit-yukyu-modal" class="confirm-modal">
        <div class="confirm-modal-content modal-sm">
            <div class="confirm-modal-title">
                ✏️ 有給使用データを編集
            </div>

            <!-- Employee Info Header -->
            <div class="bg-primary-subtle p-md rounded mb-lg">
                <div class="flex-between">
                    <div>
                        <div id="edit-emp-name" class="font-semibold text-lg">-</div>
                        <div id="edit-emp-num" class="text-muted text-sm">社員番号: -</div>
                    </div>
                    <div class="text-right">
                        <div class="stat-label">現在の残日数</div>
                        <div id="edit-emp-balance" class="text-2xl font-bold text-success">-</div>
                    </div>
                </div>
            </div>

            <!-- Usage Details List -->
            <div class="form-section mb-lg">
                <div class="form-section-title">📅 使用日一覧</div>
                <div id="edit-usage-list" class="usage-list-container max-h-300 overflow-y-auto">
                    <div class="text-center text-muted p-lg">
                        従業員を選択してください...
                    </div>
                </div>
            </div>

            <!-- Add New Usage -->
            <div class="form-section mb-lg">
                <div class="form-section-title">➕ 新しい使用日を追加</div>
                <div class="grid grid-cols-3 gap-md">
                    <div class="form-group">
                        <label for="add-use-date">日付</label>
                        <input type="date" id="add-use-date" class="input-glass w-full">
                    </div>
                    <div class="form-group">
                        <label for="add-days-used">日数</label>
                        <select id="add-days-used" class="input-glass w-full">
                            <option value="1.0">1日 (全日)</option>
                            <option value="0.5">0.5日 (半日)</option>
                            <option value="0.25">0.25日 (2時間)</option>
                        </select>
                    </div>
                    <div class="form-group flex-align-end">
                        <button class="btn btn-primary w-full" data-action="editYukyu.addUsage">
                            追加
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-info-subtle p-md rounded mb-lg">
                <div class="flex-between">
                    <span>変更後の使用日数:</span>
                    <span id="edit-total-used" class="font-bold">0日</span>
                </div>
                <div class="flex-between mt-sm">
                    <span>変更後の残日数:</span>
                    <span id="edit-new-balance" class="font-bold text-success">0日</span>
                </div>
            </div>

            <div class="confirm-actions">
                <button class="btn btn-glass" data-action="editYukyu.closeModal">
                    キャンセル
                </button>
                <button class="btn btn-secondary" data-action="auditHistory.showEntityHistory" data-entity="employee">
                    📜 履歴を見る
                </button>
                <button class="btn btn-primary" id="edit-save-btn" data-action="editYukyu.saveChanges">
                    💾 変更を保存
                </button>
            </div>
        </div>
    </div>

    <!-- Audit History Modal (v2.3 - NEW) -->
    <div id="audit-history-modal" class="confirm-modal">
        <div class="confirm-modal-content modal-lg">
            <div class="confirm-modal-title">
                📜 変更履歴
            </div>

            <div class="bg-primary-subtle p-md rounded mb-lg">
                <div class="flex-between">
                    <div>
                        <div id="audit-entity-info" class="font-semibold">エンティティ情報</div>
                    </div>
                    <div>
                        <select id="audit-action-filter" class="input-glass" onchange="App.auditHistory.applyFilter()">
                            <option value="">全てのアクション</option>
                            <option value="CREATE">CREATE</option>
                            <option value="UPDATE">UPDATE</option>
                            <option value="DELETE">DELETE</option>
                            <option value="APPROVE">APPROVE</option>
                            <option value="REJECT">REJECT</option>
                            <option value="REVERT">REVERT</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="audit-history-list" class="usage-list-container max-h-500">
                <div class="text-center text-muted p-lg">
                    <div class="spinner margin-auto"></div>
                    <p class="mt-md">履歴を読み込み中...</p>
                </div>
            </div>

            <div class="confirm-actions">
                <button class="btn btn-glass" data-action="auditHistory.closeModal">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- Import Result Modal (v2.2 - NEW) -->
    <div id="import-result-modal" class="confirm-modal">
        <div class="confirm-modal-content import-result-content modal-md">
            <div class="confirm-modal-title" id="import-result-title">
                <span id="import-result-icon">📊</span> インポート結果
            </div>

            <!-- Status Summary Banner -->
            <div id="import-status-banner" class="import-status-banner import-status-success">
                <div class="import-status-icon">✅</div>
                <div class="import-status-text">
                    <div class="import-status-title" id="import-status-title">インポート完了</div>
                    <div class="import-status-subtitle" id="import-status-subtitle">全てのデータが正常に処理されました</div>
                </div>
            </div>

            <!-- Statistics Grid -->
            <div class="import-stats-grid">
                <div class="import-stat-card import-stat-total">
                    <div class="import-stat-value" id="import-stat-total">0</div>
                    <div class="import-stat-label">総レコード</div>
                </div>
                <div class="import-stat-card import-stat-success">
                    <div class="import-stat-value" id="import-stat-success">0</div>
                    <div class="import-stat-label">成功</div>
                </div>
                <div class="import-stat-card import-stat-warning">
                    <div class="import-stat-value" id="import-stat-warnings">0</div>
                    <div class="import-stat-label">警告</div>
                </div>
                <div class="import-stat-card import-stat-error">
                    <div class="import-stat-value" id="import-stat-errors">0</div>
                    <div class="import-stat-label">エラー</div>
                </div>
            </div>

            <!-- Breakdown Section -->
            <div class="import-breakdown-section" id="import-breakdown-section">
                <div class="form-section-title">📋 詳細内訳</div>
                <div class="import-breakdown-grid" id="import-breakdown-grid">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Warnings List (Expandable) -->
            <div class="import-warnings-section hidden" id="import-warnings-section">
                <div class="import-warnings-header" data-action="importReport.toggleWarnings">
                    <span class="form-section-title">⚠️ 警告一覧</span>
                    <span class="import-warnings-toggle" id="import-warnings-toggle">▼</span>
                </div>
                <div class="import-warnings-list hidden" id="import-warnings-list">
                    <!-- Warning items will be added dynamically -->
                </div>
            </div>

            <!-- Errors List (Expandable) -->
            <div class="import-errors-section hidden" id="import-errors-section">
                <div class="import-errors-header" data-action="importReport.toggleErrors">
                    <span class="form-section-title">❌ エラー一覧</span>
                    <span class="import-errors-toggle" id="import-errors-toggle">▼</span>
                </div>
                <div class="import-errors-list hidden" id="import-errors-list">
                    <!-- Error items will be added dynamically -->
                </div>
            </div>

            <!-- Problematic Employees (Optional) -->
            <div class="import-problems-section hidden" id="import-problems-section">
                <div class="form-section-title">👤 要確認従業員</div>
                <div class="import-problems-list" id="import-problems-list">
                    <!-- Problem employee items -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="confirm-actions mt-lg">
                <button class="btn btn-glass" data-action="importReport.downloadReport">
                    📥 レポートをダウンロード
                </button>
                <button class="btn btn-primary" data-action="importReport.closeModal">
                    ✓ 閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal (v2.3 - NEW) -->
    <div id="bulk-edit-modal" class="confirm-modal">
        <div class="confirm-modal-content modal-lg">
            <div class="confirm-modal-title">
                <span class="bulk-edit-icon">✏️</span>
                一括編集 (Bulk Edit)
            </div>

            <!-- Selected Employees Count -->
            <div class="bulk-edit-selection-info">
                <div class="bulk-edit-count">
                    <span id="bulk-edit-count">0</span> 名選択中
                </div>
                <button class="btn btn-sm btn-glass" data-action="bulkEdit.clearSelection">
                    選択解除
                </button>
            </div>

            <!-- Selected Employees List (Collapsible) -->
            <div class="bulk-edit-employees-section">
                <div class="bulk-edit-employees-header" data-action="bulkEdit.toggleEmployeeList">
                    <span class="form-section-title">👥 選択された従業員</span>
                    <span class="bulk-edit-toggle" id="bulk-edit-employees-toggle">▼</span>
                </div>
                <div class="bulk-edit-employees-list max-h-150" id="bulk-edit-employees-list">
                    <!-- Employee chips will be added dynamically -->
                </div>
            </div>

            <!-- Edit Fields Section -->
            <div class="bulk-edit-fields-section">
                <div class="form-section-title">📝 編集内容</div>

                <!-- Add Granted Days -->
                <div class="bulk-edit-field-row">
                    <label class="bulk-edit-checkbox">
                        <input type="checkbox" id="bulk-edit-add-granted-check"
                            onchange="App.bulkEdit.toggleField('add_granted')">
                        <span>付与日数を追加</span>
                    </label>
                    <div class="bulk-edit-input-group hidden" id="bulk-edit-add-granted-group">
                        <span class="bulk-edit-prefix">+</span>
                        <input type="number" id="bulk-edit-add-granted" class="input-glass" min="0" max="20" step="0.5"
                            placeholder="0">
                        <span class="bulk-edit-suffix">日</span>
                    </div>
                </div>

                <!-- Add Used Days -->
                <div class="bulk-edit-field-row">
                    <label class="bulk-edit-checkbox">
                        <input type="checkbox" id="bulk-edit-add-used-check"
                            onchange="App.bulkEdit.toggleField('add_used')">
                        <span>使用日数を追加</span>
                    </label>
                    <div class="bulk-edit-input-group hidden" id="bulk-edit-add-used-group">
                        <span class="bulk-edit-prefix">+</span>
                        <input type="number" id="bulk-edit-add-used" class="input-glass" min="0" max="40" step="0.5"
                            placeholder="0">
                        <span class="bulk-edit-suffix">日</span>
                    </div>
                </div>

                <!-- Change Haken (Factory) -->
                <div class="bulk-edit-field-row">
                    <label class="bulk-edit-checkbox">
                        <input type="checkbox" id="bulk-edit-set-haken-check"
                            onchange="App.bulkEdit.toggleField('set_haken')">
                        <span>派遣先を変更</span>
                    </label>
                    <div class="bulk-edit-input-group hidden" id="bulk-edit-set-haken-group">
                        <select id="bulk-edit-set-haken" class="input-glass">
                            <option value="">派遣先を選択...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="bulk-edit-preview-section hidden" id="bulk-edit-preview-section">
                <div class="form-section-title">🔍 変更プレビュー</div>
                <div class="bulk-edit-preview-list" id="bulk-edit-preview-list">
                    <!-- Preview items will be added dynamically -->
                </div>
            </div>

            <!-- Warnings Section -->
            <div class="bulk-edit-warnings-section hidden" id="bulk-edit-warnings-section">
                <div class="form-section-title text-warning">⚠️ 警告</div>
                <div class="bulk-edit-warnings-list" id="bulk-edit-warnings-list">
                    <!-- Warning items -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="confirm-actions mt-lg">
                <button class="btn btn-glass" data-action="bulkEdit.closeModal">
                    キャンセル
                </button>
                <button class="btn btn-info" data-action="bulkEdit.preview">
                    🔍 プレビュー
                </button>
                <button class="btn btn-primary" id="bulk-edit-apply-btn" data-action="bulkEdit.apply" disabled>
                    ✓ 適用する
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Bulk Edit Modal Styles (v2.3) */
        .bulk-edit-selection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .bulk-edit-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .bulk-edit-count span {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .bulk-edit-employees-section {
            margin-bottom: 1rem;
        }

        .bulk-edit-employees-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
        }

        .bulk-edit-employees-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .bulk-edit-employee-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: rgba(37, 99, 235, 0.2);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .bulk-edit-employee-chip .remove {
            cursor: pointer;
            opacity: 0.6;
        }

        .bulk-edit-employee-chip .remove:hover {
            opacity: 1;
            color: var(--danger);
        }

        .bulk-edit-fields-section {
            margin-bottom: 1.5rem;
        }

        .bulk-edit-field-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bulk-edit-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .bulk-edit-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .bulk-edit-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bulk-edit-input-group input,
        .bulk-edit-input-group select {
            width: 150px;
        }

        .bulk-edit-prefix,
        .bulk-edit-suffix {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .bulk-edit-preview-section,
        .bulk-edit-warnings-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .bulk-edit-preview-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .bulk-edit-preview-item {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 1fr;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
        }

        .bulk-edit-preview-item:last-child {
            border-bottom: none;
        }

        .bulk-edit-preview-header {
            font-weight: 600;
            color: var(--text-muted);
        }

        .bulk-edit-change-arrow {
            color: var(--primary);
        }

        .bulk-edit-warnings-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bulk-edit-warning-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid var(--warning);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Table checkbox column */
        .table-checkbox {
            width: 30px;
            text-align: center;
        }

        .table-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        /* Bulk edit toolbar */
        .bulk-edit-toolbar {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(37, 99, 235, 0.1));
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .bulk-edit-toolbar.active {
            display: flex;
        }

        .bulk-edit-toolbar-count {
            font-weight: 600;
            color: var(--primary);
        }

        .bulk-edit-icon {
            margin-right: 0.5rem;
        }
    </style>

    <style>
        /* Import Result Modal Styles (v2.2) */
        .import-result-content {
            padding: 1.5rem;
        }

        .import-status-banner {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .import-status-success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .import-status-warning {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .import-status-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .import-status-icon {
            font-size: 2rem;
        }

        .import-status-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .import-status-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .import-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .import-stat-card {
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .import-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .import-stat-total {
            border-color: rgba(37, 99, 235, 0.3);
        }

        .import-stat-success {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .import-stat-warning {
            border-color: rgba(251, 191, 36, 0.3);
        }

        .import-stat-error {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .import-stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            line-height: 1;
        }

        .import-stat-total .import-stat-value {
            color: var(--primary);
        }

        .import-stat-success .import-stat-value {
            color: var(--success);
        }

        .import-stat-warning .import-stat-value {
            color: var(--warning);
        }

        .import-stat-error .import-stat-value {
            color: var(--danger);
        }

        .import-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .import-breakdown-section {
            margin-bottom: 1.5rem;
        }

        .import-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .import-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .import-breakdown-label {
            color: var(--text-secondary);
        }

        .import-breakdown-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .import-warnings-section,
        .import-errors-section {
            margin-bottom: 1rem;
        }

        .import-warnings-header,
        .import-errors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .import-warnings-header:hover,
        .import-errors-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .import-warnings-header .form-section-title,
        .import-errors-header .form-section-title {
            margin: 0;
        }

        .import-warnings-toggle,
        .import-errors-toggle {
            transition: transform 0.3s;
        }

        .import-warnings-toggle.expanded,
        .import-errors-toggle.expanded {
            transform: rotate(180deg);
        }

        .import-warnings-list,
        .import-errors-list {
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .import-warning-item,
        .import-error-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .import-warning-item:last-child,
        .import-error-item:last-child {
            border-bottom: none;
        }

        .import-warning-item {
            color: var(--warning);
        }

        .import-error-item {
            color: var(--danger);
        }

        .import-warning-item .item-icon,
        .import-error-item .item-icon {
            flex-shrink: 0;
        }

        .import-warning-item .item-text,
        .import-error-item .item-text {
            flex: 1;
        }

        .import-warning-item .item-row,
        .import-error-item .item-row {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-left: auto;
        }

        .import-problems-section {
            margin-bottom: 1rem;
        }

        .import-problems-list {
            display: grid;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .import-problem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.2);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .import-problem-employee {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .import-problem-name {
            font-weight: 600;
        }

        .import-problem-num {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .import-problem-issue {
            color: var(--danger);
            font-weight: 500;
        }

        .import-problem-action {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--danger);
            color: white;
            cursor: pointer;
            border: none;
        }

        .import-problem-action:hover {
            filter: brightness(1.1);
        }

        /* Light theme adjustments */
        [data-theme="light"] .import-stat-card {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .import-warnings-list,
        [data-theme="light"] .import-errors-list {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .import-warning-item,
        [data-theme="light"] .import-error-item {
            border-color: rgba(0, 0, 0, 0.05);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .import-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .import-breakdown-grid {
                grid-template-columns: 1fr;
            }

            .import-result-content {
                padding: 1rem;
            }
        }
    </style>

    <style>
        /* Edit Yukyu Modal Styles */
        .usage-list-container {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
        }

        .usage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .usage-item:last-child {
            border-bottom: none;
        }

        .usage-item:hover {
            background: var(--bg-hover);
        }

        .usage-item-date {
            font-weight: 500;
        }

        .usage-item-days {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .usage-item-days select {
            width: 120px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .usage-item-delete {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .usage-item-delete:hover {
            background: var(--danger-dark);
        }

        .usage-item.pending-delete {
            background: rgba(239, 68, 68, 0.1);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .usage-item.pending-add {
            background: rgba(34, 197, 94, 0.1);
        }

        .usage-item.pending-update {
            background: rgba(59, 130, 246, 0.1);
        }
    </style>

    <!-- Login Modal -->
    <div class="modal-overlay" id="login-modal" role="dialog" aria-modal="true" aria-labelledby="login-modal-title">
        <div class="modal-container">
            <!-- Branding -->
            <div class="login-branding">
                <div class="login-logo" aria-hidden="true">有</div>
                <h2 id="login-modal-title" class="login-title">YuKyuDATA</h2>
                <p class="login-subtitle">有給休暇管理システム</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="login-form" autocomplete="off">
                <div class="form-group">
                    <label for="login-username" class="form-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                        Username
                    </label>
                    <input type="text" id="login-username" name="username" class="form-control"
                        placeholder="Enter your username" required autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="login-password" class="form-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                        Password
                    </label>
                    <div class="password-input-wrapper">
                        <input type="password" id="login-password" name="password" class="form-control"
                            placeholder="Enter your password" required autocomplete="current-password">
                        <button type="button" class="toggle-password" aria-label="Toggle password visibility"
                            tabindex="-1">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-off-icon"
                                style="display:none">
                                <path
                                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" />
                                <line x1="1" y1="1" x2="23" y2="23" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="alert alert-error" id="login-error" style="display: none;">
                    Invalid credentials
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-login" id="login-submit">
                        <span class="btn-text">Log In</span>
                        <span class="btn-spinner d-none"></span>
                    </button>
                </div>

                <div class="dev-credentials" id="dev-creds" style="display: none;">
                    <strong>Development Mode</strong><br>
                    <code id="dev-creds-info">Check server console for credentials</code>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application Logic -->
    <script src="/static/js/app.js"></script>
    <script>
        // Login modal enhancements (password toggle + overlay close)
        document.addEventListener('DOMContentLoaded', function () {
            var toggle = document.querySelector('#login-modal .toggle-password');
            var pwInput = document.getElementById('login-password');
            if (toggle && pwInput) {
                toggle.addEventListener('click', function () {
                    var isPassword = pwInput.type === 'password';
                    pwInput.type = isPassword ? 'text' : 'password';
                    toggle.querySelector('.eye-icon').style.display = isPassword ? 'none' : '';
                    toggle.querySelector('.eye-off-icon').style.display = isPassword ? '' : 'none';
                });
            }
            var overlay = document.getElementById('login-modal');
            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) overlay.classList.remove('active');
                });
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && overlay.classList.contains('active')) {
                        overlay.classList.remove('active');
                    }
                });
            }
        });
    </script>
</body>

</html>
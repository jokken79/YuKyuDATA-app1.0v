# =============================================================================
# FASE 3: Advanced Security Scanning
# =============================================================================
# Comprehensive security scanning with:
# - Trivy: Container and filesystem vulnerability scanning
# - Checkov: Infrastructure as Code (Terraform) scanning
# - CodeQL: GitHub's code analysis engine
# - Dependency check: OWASP dependency vulnerabilities
# - Secret scanning: Detecting hardcoded secrets
# =============================================================================

name: Advanced Security Scanning

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Run daily security scans at 3 AM UTC
    - cron: '0 3 * * *'

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  # ============================================================================
  # Container Scanning - Trivy
  # ============================================================================
  container-scan-trivy:
    name: Container Scan (Trivy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image for scanning
        if: steps.dockerfile.outputs.exists == 'true'
        run: |
          docker build -t yukyu-app:scan . || echo "::warning::Docker build failed"
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        if: steps.dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'yukyu-app:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.dockerfile.outputs.exists == 'true'
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container'
        continue-on-error: true

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          skip-dirs: 'node_modules,venv,.git,backups,basuraa,ThemeTheBestJpkken'
        continue-on-error: true

      - name: Upload Trivy filesystem results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'
        continue-on-error: true

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-reports
          path: |
            trivy-results.sarif
            trivy-fs-results.sarif
          retention-days: 30

  # ============================================================================
  # Infrastructure as Code Scanning - Checkov
  # ============================================================================
  infrastructure-scan-checkov:
    name: Infrastructure Scan (Checkov)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Terraform files
        id: terraform
        run: |
          if [ -d "terraform" ] && ls terraform/*.tf 1> /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::No Terraform files found - skipping infrastructure scan"
          fi

      - name: Run Checkov scan on Terraform
        if: steps.terraform.outputs.exists == 'true'
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          skip_check: CKV_GIT_1,CKV_GENERAL_1
        continue-on-error: true

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.terraform.outputs.exists == 'true'
        with:
          sarif_file: 'checkov-results.sarif'
          category: 'checkov-terraform'
        continue-on-error: true

      - name: Run Checkov on Dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            pip install checkov
            checkov -f Dockerfile --framework dockerfile --output cli || echo "::warning::Checkov found issues"
          else
            echo "No Dockerfile found"
          fi
        continue-on-error: true

  # ============================================================================
  # Code Analysis - CodeQL (GitHub's native)
  # ============================================================================
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ['python', 'javascript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Set up Python (for Python analysis)
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        if: matrix.language == 'python'
        run: |
          pip install -r requirements.txt || echo "Could not install requirements"
        continue-on-error: true

      - name: Set up Node.js (for JavaScript analysis)
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-${{ matrix.language }}

  # ============================================================================
  # OWASP Dependency Check
  # ============================================================================
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'YuKyuDATA'
          path: '.'
          format: 'JSON'
          args: >
            --enableExperimental
            --exclude node_modules,venv,.git,backups,basuraa,ThemeTheBestJpkken,.agent
        continue-on-error: true

      - name: Upload Dependency Check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: 'reports/'
          retention-days: 30

  # ============================================================================
  # Secret Scanning - Detect hardcoded credentials
  # ============================================================================
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          pip install truffleHog3

      - name: Run TruffleHog scan
        run: |
          trufflehog3 -r . > trufflehog-report.txt 2>&1 || true
          if [ -s trufflehog-report.txt ]; then
            echo "::warning::TruffleHog found potential secrets"
          fi
        continue-on-error: true

      - name: Check for high-entropy strings
        run: |
          pip install detect-secrets
          detect-secrets scan . > .secrets.baseline 2>&1 || true
        continue-on-error: true

      - name: Check for common patterns
        run: |
          python3 << 'PYEOF'
          import re
          import sys
          import os

          patterns = {
              'AWS_ACCESS_KEY': r'AKIA[0-9A-Z]{16}',
              'PRIVATE_KEY': r'-----BEGIN PRIVATE KEY-----',
              'DATABASE_PASSWORD': r'password\s*[:=]\s*["\']([^"\']{8,})["\']',
          }

          findings = []
          skip_dirs = {'node_modules', 'venv', '.git', '__pycache__', 'backups', '.pytest_cache', 'basuraa', 'ThemeTheBestJpkken'}
          skip_files = {'.env.example', '.env.sample', 'CLAUDE.md', 'README.md'}

          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in skip_dirs]

              for file in files:
                  if file.startswith('.') or file in skip_files:
                      continue

                  filepath = os.path.join(root, file)

                  try:
                      with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                          content = f.read()

                          for pattern_name, pattern in patterns.items():
                              if re.search(pattern, content, re.IGNORECASE):
                                  findings.append({
                                      'file': filepath,
                                      'pattern': pattern_name
                                  })
                  except Exception:
                      pass

          if findings:
              print(f"::warning::Found {len(findings)} potential secrets")
              for finding in findings[:10]:
                  print(f"  - {finding['file']}: {finding['pattern']}")
          else:
              print("No obvious secrets found")

          sys.exit(0)
          PYEOF

      - name: Upload secret scanning report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scanning-report
          path: |
            trufflehog-report.txt
            .secrets.baseline
          retention-days: 30

  # ============================================================================
  # License Compliance Scanning
  # ============================================================================
  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python package licenses
        run: |
          pip install pip-licenses
          pip install -r requirements.txt || true
          pip-licenses --format=json --output-file=python-licenses.json || true
          pip-licenses --format=markdown --output-file=python-licenses.md || true
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check NPM package licenses
        run: |
          npm install || true
          npx license-checker --json > npm-licenses.json 2>/dev/null || true
          npm list --depth=0 > npm-tree.txt || true
        continue-on-error: true

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-reports
          path: |
            python-licenses.json
            python-licenses.md
            npm-licenses.json
            npm-tree.txt
          retention-days: 30

  # ============================================================================
  # SBOM (Software Bill of Materials) Generation
  # ============================================================================
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM for filesystem
        run: |
          syft . -o spdx-json > sbom-fs.spdx.json || true
          syft . -o cyclonedx-json > sbom-fs.cyclonedx.json || true

      - name: Check for Dockerfile and generate image SBOM
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t yukyu-app:sbom . 2>/dev/null || true
            if docker image inspect yukyu-app:sbom > /dev/null 2>&1; then
              syft yukyu-app:sbom -o spdx-json > sbom.spdx.json || true
              syft yukyu-app:sbom -o cyclonedx-json > sbom.cyclonedx.json || true
            fi
          fi
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: |
            sbom*.json
          retention-days: 90

  # ============================================================================
  # Security Summary & Reporting
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [container-scan-trivy, infrastructure-scan-checkov, codeql-analysis, secret-scanning]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy (Container & Filesystem) | ${{ needs.container-scan-trivy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov (Infrastructure) | ${{ needs.infrastructure-scan-checkov.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all SARIF reports in GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Check artifacts for detailed vulnerability information" >> $GITHUB_STEP_SUMMARY
          echo "3. Address CRITICAL and HIGH severity issues before merging" >> $GITHUB_STEP_SUMMARY
          echo "4. Enable branch protection requiring security checks to pass" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

name: Secure Deployment Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Daily security scan at 2 AM UTC
    - cron: '0 2 * * *'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.11'

# Limit concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # 1. STATIC APPLICATION SECURITY TESTING
  # ============================================
  sast:
    name: SAST - Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/python
            p/fastapi
          generateSarif: true
        continue-on-error: true

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        continue-on-error: true

      - name: Run Bandit (Python security)
        run: |
          pip install bandit
          bandit -r . -ll -f json -o bandit-report.json \
            --exclude ./node_modules,./venv,./backups,./tests,./.git,./basuraa,./ThemeTheBestJpkken \
            || echo "Bandit scan complete"
          bandit -r . -ll \
            --exclude ./node_modules,./venv,./backups,./tests,./.git,./basuraa,./ThemeTheBestJpkken \
            || true

      - name: Run Pylint
        run: |
          pip install pylint
          pylint main.py database.py --fail-under=5 || echo "Pylint issues found"
        continue-on-error: true

  # ============================================
  # 2. DEPENDENCY VULNERABILITY SCANNING
  # ============================================
  dependency-scan:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Safety check
        run: |
          pip install safety
          safety check --json > safety-report.json 2>&1 || true
          safety check || echo "::warning::Some vulnerabilities found"
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip install pip-audit
          pip-audit --desc || echo "::warning::pip-audit found issues"
        continue-on-error: true

      - name: Upload Dependency reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: |
            safety-report.json
          retention-days: 30

  # ============================================
  # 3. SECRET SCANNING
  # ============================================
  secret-scan:
    name: Secret & Credentials Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --json
        continue-on-error: true

      - name: GitGuardian Scan
        if: ${{ secrets.GITGUARDIAN_API_KEY != '' }}
        uses: gitguardian/ggshield-action@master
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        with:
          args: -v --json
        continue-on-error: true

      - name: Skip GitGuardian (no API key)
        if: ${{ secrets.GITGUARDIAN_API_KEY == '' }}
        run: |
          echo "::notice::GitGuardian scan skipped - GITGUARDIAN_API_KEY not configured"

      - name: Check for hardcoded secrets
        run: |
          python3 << 'PYEOF'
          import os
          import re

          patterns = {
              'api_key': r'api[_-]?key\s*[:=]\s*["\'][^"\']+["\']',
              'password': r'password\s*[:=]\s*["\'][^"\']+["\']',
              'token': r'token\s*[:=]\s*["\'][^"\']+["\']',
              'secret': r'secret\s*[:=]\s*["\'][^"\']+["\']',
          }

          skip_dirs = {'.git', '__pycache__', '.pytest_cache', 'node_modules', 'venv', 'backups', 'basuraa', 'ThemeTheBestJpkken'}
          skip_files = {'.env.example', '.env.sample', 'conftest.py'}

          found = False
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in skip_dirs]

              for file in files:
                  if file in skip_files:
                      continue
                  if file.endswith(('.py', '.js', '.yaml', '.yml')):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                              content = f.read()
                              for i, line in enumerate(content.split('\n'), 1):
                                  # Skip comments and env var references
                                  if line.strip().startswith('#') or 'os.getenv' in line or 'environ' in line:
                                      continue
                                  for pattern_name, pattern in patterns.items():
                                      if re.search(pattern, line, re.IGNORECASE):
                                          print(f'WARNING: Possible {pattern_name} in {filepath}:{i}')
                                          found = True
                      except Exception:
                          pass

          if found:
              print('::warning::Potential secrets detected - please review')
          else:
              print('No obvious secrets found')
          PYEOF
        continue-on-error: true

  # ============================================
  # 4. CODE QUALITY
  # ============================================
  code-quality:
    name: Code Quality & Best Practices
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Black (Code formatting)
        run: |
          pip install black
          black --check --line-length=120 . \
            --exclude='/(node_modules|venv|\.git|__pycache__|backups|basuraa|ThemeTheBestJpkken)/' \
            || echo "::warning::Some files need formatting"
        continue-on-error: true

      - name: Run isort (Import sorting)
        run: |
          pip install isort
          isort --check-only --profile=black --line-length=120 . \
            --skip node_modules --skip venv --skip backups --skip basuraa --skip ThemeTheBestJpkken \
            || echo "::warning::Imports need sorting"
        continue-on-error: true

      - name: Run Flake8 (Code style)
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=node_modules,venv,.git,__pycache__,backups,basuraa,ThemeTheBestJpkken

      - name: Run type checking (mypy)
        run: |
          pip install mypy
          mypy . --ignore-missing-imports \
            --exclude='venv|node_modules|backups|basuraa|ThemeTheBestJpkken' \
            || echo "::warning::Type issues found"
        continue-on-error: true

  # ============================================
  # 5. BUILD DOCKER IMAGE (Optional)
  # ============================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [sast, dependency-scan, secret-scan]
    if: always() && !contains(needs.*.result, 'failure')
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [ -f "Dockerfile" ] || [ -f "Dockerfile.secure" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::No Dockerfile found - skipping build"
          fi

      - name: Set up Docker Buildx
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.dockerfile.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=ref,event=branch
            type=sha,prefix={{branch}}-

      - name: Build Docker image (no push on PR)
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ hashFiles('Dockerfile.secure') != '' && 'Dockerfile.secure' || 'Dockerfile' }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

  # ============================================
  # 6. SECURITY TESTS
  # ============================================
  security-tests:
    name: Security Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run security tests
        run: |
          mkdir -p backups
          pytest tests/ -v --cov=. --cov-report=xml --tb=short \
            -k "security or auth or api" \
            --ignore=node_modules --ignore=backups --ignore=basuraa --ignore=ThemeTheBestJpkken \
            || echo "::warning::Some security tests failed"
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: security
        continue-on-error: true

  # ============================================
  # 7. SUMMARY
  # ============================================
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast, dependency-scan, secret-scan, code-quality, build, security-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Secure Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Semgrep/Bandit) | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if critical jobs failed
          if [ "${{ needs.sast.result }}" == "failure" ] || \
             [ "${{ needs.secret-scan.result }}" == "failure" ]; then
            echo "::error::Critical security checks failed"
            exit 1
          fi

          echo "Security pipeline completed!"
